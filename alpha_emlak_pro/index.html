<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:;">
    <title>Alpha Craft Portföy v2.0</title>

    <!-- Modern Font ve Stil Kütüphaneleri -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Leaflet Map REMOVED -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.osmbuildings.org/4.1.1/OSMBuildings.js"></script> <!-- TRUE 3D CITY LIB -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: { 950: '#010409', 900: '#020617', 800: '#0f172a', 700: '#1e293b' },
                        brand: { 400: '#10b981', 500: '#059669' },
                        accent: { primary: '#f59e0b', secondary: '#0ea5e9', danger: '#ef4444', ai: '#8b5cf6', success: '#22c55e' }
                    }
                }
            }
        }
    </script>
    <style>
        html {
            font-size: 14px;
        }

        body {
            background-color: #020617;
            color: #f8fafc;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }

        #splash-screen {
            position: fixed;
            inset: 0;
            background: #010409;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.8s ease, visibility 0.8s;
        }

        .splash-logo-box {
            animation: logoFloat 3s infinite ease-in-out;
        }

        @keyframes logoFloat {

            0%,
            100% {
                transform: translateY(0);
                filter: drop-shadow(0 0 10px rgba(16, 185, 129, 0.2));
            }

            50% {
                transform: translateY(-10px);
                filter: drop-shadow(0 0 20px rgba(16, 185, 129, 0.4));
            }
        }

        .slogan-text {
            overflow: hidden;
            border-right: .15em solid #10b981;
            white-space: nowrap;
            margin: 0 auto;
            letter-spacing: .4em;
            font-size: 1.1rem;
            font-weight: 700;
            text-transform: uppercase;
            color: #10b981;
            /* "ARTIK KOLAY" is 11 chars. steps(12) ensures clean typing. fit-content ensures full visibility */
            width: fit-content;
            max-width: 0;
            animation: typing 2.5s steps(12, end) forwards,
                blink-caret .75s step-end infinite;
        }

        @keyframes typing {
            from {
                max-width: 0
            }

            to {
                max-width: 100%
            }
        }

        @keyframes blink-caret {

            from,
            to {
                border-color: transparent
            }

            50% {
                border-color: #10b981
            }
        }

        .label-text {
            color: #94a3b8 !important;
            font-weight: 700;
        }

        /* NEON LED BUILDINGS - SUBTLE MARKERS */
        /* SADELEŞTİRİLMİŞ NEON (Müşteri İsteği) */
        .neon-led-marker {
            position: relative;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            /* Daha az parlak gölge */
            box-shadow: 0 0 5px currentColor, 0 0 10px currentColor;
            animation: led-pulse 3s infinite ease-in-out;
        }

        .neon-led-marker::after {
            content: '';
            position: absolute;
            top: -4px;
            /* Daha küçük hale (ripple) */
            left: -4px;
            right: -4px;
            bottom: -4px;
            border: 1px solid currentColor;
            border-radius: 50%;
            opacity: 0;
            animation: led-ripple 3s infinite ease-out;
            /* Daha yavaş */
        }

        @keyframes led-pulse {

            0%,
            100% {
                transform: scale(1);
                opacity: 0.9;
            }

            50% {
                transform: scale(1.2);
                opacity: 0.7;
            }
        }

        @keyframes led-ripple {
            0% {
                transform: scale(0.5);
                opacity: 0.5;
            }

            100% {
                transform: scale(2.0);
                opacity: 0;
            }
        }

        /* 3D MAP CONTAINER - GÖRÜNÜR YAZILAR */
        /* 3D MAP CONTAINER - GÖRÜNÜR YAZILAR */
        .holo-container {
            background: #0b0f19 !important;
            /* Force Dark Background */
            position: relative;
        }

        /* REMOVE FILTERS TO FIX BLANK MAP */
        /* .holo-container .leaflet-tile-pane {
            filter: contrast(1.1) brightness(1.1) saturate(1.2) hue-rotate(190deg);
        } */

        /* HARİTA MAHALLE YAZILARI */
        .map-text-label {
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            font-size: 10px;
            font-weight: 800;
            color: rgba(255, 255, 255, 0.9) !important;
            text-shadow: 0 0 4px #000;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            /* Tıklamayı engelle */
        }

        /* HOLOGRAPHIC GRID OVERLAY - REMOVED FOR VISIBILITY
        .holo-container::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(rgba(14, 165, 233, 0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(14, 165, 233, 0.1) 1px, transparent 1px);
            background-size: 40px 40px;
            pointer-events: none;
            z-index: 400;
            box-shadow: inset 0 0 100px rgba(0,0,0,0.8);
        } */

        /* MAP CONTROL PANEL */
        .map-control-panel {
            position: absolute;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background: rgba(11, 15, 25, 0.8);
            backdrop-filter: blur(10px);
            padding: 8px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
        }

        /* CRITICAL LEAFLET FIX FOR TAILWIND */
        .leaflet-tile-pane img,
        img.leaflet-tile {
            max-width: none !important;
            max-height: none !important;
        }

        /* FORCE BLACK BACKGROUND FOR MAP */
        .leaflet-container {
            background-color: #0b0f19 !important;
            font-family: 'Inter', sans-serif;
        }

        /* Make abstract vectors glow */
        .leaflet-interactive {
            transition: all 0.3s ease;
        }

        .map-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: #94a3b8;
            font-size: 14px;
            transition: all 0.2s ease;
            cursor: pointer;
            border: 1px solid transparent;
        }

        .map-btn:hover {
            background: rgba(14, 165, 233, 0.2);
            color: #fff;
            border-color: rgba(14, 165, 233, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.2);
        }

        /* OPTIMIZED HOVER */
        .glass-card {
            will-change: transform, opacity;
            /* GPU Hint */
            backface-visibility: hidden;
        }

        .leaflet-popup {
            bottom: 20px !important;
        }



        /* TECH POPUP */
        .leaflet-popup-content-wrapper {
            background: rgba(2, 6, 23, 0.90) !important;
            border: 1px solid rgba(14, 165, 233, 0.5) !important;
            box-shadow: 0 0 30px rgba(14, 165, 233, 0.15) !important;
            border-radius: 2px !important;
            color: #fff !important;
            backdrop-filter: blur(8px);
        }

        .leaflet-popup-tip {
            background: rgba(14, 165, 233, 0.5) !important;
        }

        .leaflet-popup-close-button {
            color: #0ea5e9 !important;
        }

        .tech-card-bg {
            position: relative;
            overflow: hidden;
            background: radial-gradient(circle at center, rgba(14, 165, 233, 0.1) 0%, transparent 70%);
        }

        .tech-scan-line {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: #0ea5e9;
            box-shadow: 0 0 10px #0ea5e9;
            opacity: 0.5;
            animation: scan-vertical 3s linear infinite;
            pointer-events: none;
        }

        @keyframes scan-vertical {
            0% {
                top: -10%;
                opacity: 0;
            }

            20% {
                opacity: 0.8;
            }

            90% {
                opacity: 0.8;
            }

            100% {
                top: 110%;
                opacity: 0;
            }
        }

        /* SCROLLBAR */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #020617;
        }

        ::-webkit-scrollbar-thumb {
            background: #1e293b;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #334155;
        }

        .glass {
            background: rgba(15, 23, 42, 0.98);
            backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .glass-card {
            background: linear-gradient(165deg, rgba(30, 41, 59, 0.98) 0%, rgba(15, 23, 42, 0.98) 100%);
            backdrop-filter: blur(14px);
            border: 1px solid rgba(255, 255, 255, 0.12);
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            transform: translateY(-4px);
            border-color: rgba(16, 185, 129, 0.6);
        }

        .nav-btn {
            transition: all 0.3s;
            border-left: 4px solid transparent;
            padding: 12px 20px;
            font-size: 0.85rem;
            text-align: left;
            width: 100%;
            color: #f1f5f9;
        }

        .nav-btn.active {
            background: rgba(16, 185, 129, 0.25);
            color: #10b981;
            border-left-color: #10b981;
            font-weight: 700;
        }

        .input-alpha {
            background-color: #010409 !important;
            color: #ffffff !important;
            border: 1px solid rgba(255, 255, 255, 0.15) !important;
            border-radius: 0.6rem;
            padding: 0.6rem 0.8rem;
            font-size: 0.8rem;
            outline: none;
            width: 100%;
        }

        .btn-action {
            @apply px-5 py-2 rounded-xl text-[10px] font-bold uppercase tracking-widest transition active:scale-95 shadow-lg;
        }

        .filter-bar {
            @apply flex flex-wrap items-end gap-3 p-4 glass rounded-2xl border border-white/10 mb-4;
        }

        .action-icon {
            @apply w-8 h-8 flex items-center justify-center rounded-lg transition-all hover:scale-110 active:scale-90 shadow-md;
        }

        .btn-delete {
            @apply bg-accent-danger/20 text-accent-danger hover:bg-accent-danger hover:text-white;
        }

        .btn-edit {
            @apply bg-accent-secondary/20 text-accent-secondary hover:bg-accent-secondary hover:text-white;
        }

        .btn-phone {
            @apply bg-brand-400/20 text-brand-400 hover:bg-brand-400 hover:text-white font-bold;
        }
    </style>
</head>

<body class="flex flex-col h-screen overflow-hidden">

    <!-- SPLASH SCREEN -->
    <div id="splash-screen">
        <div class="flex flex-col items-center">
            <div
                class="w-24 h-24 bg-gradient-to-br from-brand-400 to-brand-600 rounded-[2rem] flex items-center justify-center border border-brand-300/30 shadow-2xl mb-8 splash-logo-box">
                <span class="text-white text-6xl font-bold tracking-tighter">A</span>
            </div>
            <h2 class="text-2xl font-bold text-white uppercase tracking-[0.4em] mb-4">Alpha Craft <span
                    class="font-light opacity-50 text-lg">Portföy</span></h2>
            <div class="h-8 flex items-center justify-center">
                <p class="slogan-text">Artık Kolay</p>
            </div>
            <div class="mt-12 w-56 h-0.5 bg-white/5 rounded-full overflow-hidden">
                <div class="h-full bg-brand-400" id="splash-bar" style="width: 0%; transition: width 3s linear;"></div>
            </div>
        </div>
    </div>

    <!-- HEADER -->
    <header class="h-14 glass flex items-center justify-between px-8 z-50 shrink-0 border-b border-white/10 shadow-2xl">
        <div class="flex items-center gap-3">
            <div
                class="w-8 h-8 bg-gradient-to-br from-brand-400 to-brand-600 rounded-lg flex items-center justify-center border border-brand-300/30">
                <span class="text-white text-xl font-bold tracking-tighter">A</span>
            </div>
            <h1 class="text-sm font-bold text-white uppercase tracking-wider leading-none">
                Alpha Craft <span class="font-normal opacity-50 text-[10px] ml-0.5">Portföy (DEBUG)</span>
            </h1>
        </div>
        <div id="sync-status"
            class="text-[9px] text-brand-400 font-bold uppercase flex items-center gap-2 px-4 py-2 bg-brand-950/50 rounded-full border border-brand-500/30">
            <span class="w-2 h-2 rounded-full bg-brand-400 animate-pulse"></span> Veri Takibi Aktif
        </div>
        <div class="text-lg font-semibold text-white font-mono tracking-tighter" id="current-time">00:00:00</div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <!-- SIDEBAR -->
        <aside class="w-64 glass border-r border-slate-800 flex flex-col z-40 shrink-0 pt-4">
            <nav class="space-y-0.5">
                <p class="text-[9px] font-bold text-slate-500 uppercase tracking-[0.4em] mb-3 pl-6 opacity-60">YÖNETİM
                </p>
                <button onclick="APP.nav('dashboard')" id="nav-dashboard"
                    class="nav-btn active flex items-center gap-3"><i class="fa-solid fa-gauge-high w-4"></i> Genel
                    Durum</button>
                <button onclick="APP.nav('hunter')" id="nav-hunter" class="nav-btn flex items-center gap-3"><i
                        class="fa-solid fa-layer-group w-4"></i> Piyasa Verileri</button>
                <!-- Map Removed -->
                <button onclick="APP.nav('crm')" id="nav-crm" class="nav-btn flex items-center gap-3"><i
                        class="fa-solid fa-headset w-4"></i> CRM Görüşme</button>
                <button onclick="APP.nav('ai-hub')" id="nav-ai-hub" class="nav-btn flex items-center gap-3"><i
                        class="fa-solid fa-brain-circuit w-4 text-accent-ai"></i> AI Analiz Merkezi</button>
                <button onclick="APP.nav('portfolio')" id="nav-portfolio" class="nav-btn flex items-center gap-3"><i
                        class="fa-solid fa-briefcase w-4"></i> Portföyüm</button>
                <button onclick="APP.nav('randevular')" id="nav-randevular" class="nav-btn flex items-center gap-3"><i
                        class="fa-solid fa-calendar-check w-4 text-accent-secondary"></i> Takvim</button>
                <button onclick="APP.nav('reminders')" id="nav-reminders" class="nav-btn flex items-center gap-3"><i
                        class="fa-solid fa-bell w-4 text-brand-400"></i> Ajanda / Hatırlatıcılar</button>
                <!-- Veri Botu Removed -->
                <button onclick="APP.nav('archive')" id="nav-archive" class="nav-btn flex items-center gap-3"><i
                        class="fa-solid fa-box-archive w-4 text-slate-400"></i> Dijital Arşiv</button>
            </nav>

            <div class="mt-auto p-5 space-y-2 border-t border-white/5 bg-white/5">
                <button onclick="APP.actions.syncExcel()"
                    class="w-full py-3 bg-brand-500 hover:bg-brand-600 text-white rounded-xl text-[10px] font-bold uppercase transition shadow-xl active:scale-95">
                    <i class="fa-solid fa-sync-alt mr-2"></i> Excelleri Güncelle
                </button>
                <button onclick="APP.modals.openManual('add')"
                    class="w-full py-2.5 bg-white/5 border border-white/10 text-white rounded-xl text-[10px] font-bold uppercase hover:bg-white/10 transition">
                    <i class="fa-solid fa-plus-circle mr-2 text-brand-400"></i> Manuel İlan Ekle
                </button>
                <div
                    class="px-2 py-1 bg-dark-950 rounded-lg border border-white/5 text-[8px] text-slate-500 italic truncate text-center uppercase tracking-widest">
                    Alpha Craft v2.0
                </div>
            </div>
        </aside>

        <!-- MAIN -->
        <main class="flex-1 bg-[#020617] relative overflow-y-auto p-8 custom-scrollbar" id="main-content">

            <!-- VIEW: DASHBOARD -->
            <div id="view-dashboard" class="animate-fade-in space-y-5">
                <div class="grid grid-cols-4 gap-4">
                    <div class="glass-card p-5 rounded-xl shadow-lg">
                        <p class="label-text mb-1">Portföy Hacmi</p><span
                            class="text-xl font-bold text-white tracking-tighter" id="stat-valuation">0 ₺</span>
                    </div>
                    <div class="glass-card p-5 rounded-xl border-brand-500/30 shadow-lg">
                        <p class="label-text mb-1">Yeni Eklenenler</p><span
                            class="text-xl font-bold text-brand-400 tracking-tighter" id="stat-new-added">0</span>
                    </div>
                    <div class="glass-card p-5 rounded-xl border-accent-danger/30 shadow-lg">
                        <p class="label-text mb-1">Silinenler</p><span
                            class="text-xl font-bold text-accent-danger tracking-tighter" id="stat-deleted">0</span>
                    </div>
                    <div class="glass-card p-5 rounded-xl border-accent-ai/30 shadow-lg">
                        <p class="label-text mb-1">Başarı Puanı</p><span
                            class="text-xl font-bold text-accent-success tracking-tighter"
                            id="stat-success-count">0</span>
                    </div>
                </div>
                <div class="grid grid-cols-4 gap-4">
                    <div onclick="APP.nav('hunter')" class="glass-card clickable-card p-5 rounded-xl shadow-lg">
                        <p class="label-text mb-1">Toplam İlan</p><span
                            class="text-xl font-bold text-white tracking-tighter" id="stat-total">0</span>
                    </div>
                    <div onclick="APP.nav('crm')" class="glass-card clickable-card p-5 rounded-xl shadow-lg">
                        <p class="label-text mb-1">CRM Kayıt</p><span
                            class="text-xl font-bold text-brand-400 tracking-tighter" id="stat-crm">0</span>
                    </div>
                    <div onclick="APP.nav('randevular')" class="glass-card clickable-card p-5 rounded-xl shadow-lg">
                        <p class="label-text mb-1">Randevu</p><span
                            class="text-xl font-bold text-accent-secondary tracking-tighter" id="stat-randevu">0</span>
                    </div>
                    <div onclick="APP.nav('portfolio')"
                        class="glass-card clickable-card p-5 rounded-xl border-accent-danger/10 shadow-lg">
                        <p class="label-text mb-1">Portföy Sayısı</p><span
                            class="text-xl font-bold text-accent-danger tracking-tighter" id="stat-portfolio">0</span>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-6 mt-2">
                    <div class="glass p-6 rounded-2xl h-[400px] border-white/10">
                        <h3 class="text-sm font-bold mb-4 flex items-center justify-between text-white uppercase"><span
                                class="flex items-center gap-2"><i class="fa-solid fa-bell text-accent-primary"></i>
                                RANDEVULAR</span></h3>
                        <div id="dash-randevu-list" class="space-y-3 overflow-y-auto h-[300px] pr-2"></div>
                    </div>
                    <div class="glass p-6 rounded-2xl h-[400px] border-accent-ai/20 bg-accent-ai/5">
                        <h3 class="text-sm font-bold mb-4 flex items-center gap-2 text-accent-ai uppercase"><i
                                class="fa-solid fa-wand-magic-sparkles"></i> AI STRATEJİ NOTU</h3>
                        <div id="dash-ai-advice" class="space-y-3 overflow-y-auto h-[300px] pr-2"></div>
                    </div>
                    <div class="glass p-6 rounded-2xl h-[400px] border-white/10">
                        <h3 class="text-sm font-bold mb-4 flex items-center gap-2 text-white uppercase"><i
                                class="fa-solid fa-chart-pie text-brand-400"></i> PORTFÖY DAĞILIMI</h3>
                        <div class="h-[300px]"><canvas id="main-chart"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- VIEW: MAP REMOVED -->

            <!-- VIEW: HUNTER -->
            <div id="view-hunter" class="hidden animate-fade-in space-y-4">
                <div
                    class="filter-bar flex items-end gap-2 p-3 glass rounded-2xl border border-white/10 mb-4 overflow-x-auto">
                    <div class="w-28 shrink-0"><label
                            class="label-text block mb-1 ml-1 text-[9px] uppercase tracking-wider opacity-70">İşlem</label><select
                            id="filter-listing-type" onchange="APP.render.hunter()"
                            class="input-alpha text-[10px] py-1.5 px-2 h-8">
                            <option value="">Hepsi</option>
                            <option value="Satılık">Satılık</option>
                            <option value="Kiralık">Kiralık</option>
                        </select></div>
                    <div class="w-28 shrink-0"><label
                            class="label-text block mb-1 ml-1 text-[9px] uppercase tracking-wider opacity-70">Tip</label><select
                            id="filter-type" onchange="APP.render.hunter()"
                            class="input-alpha text-[10px] py-1.5 px-2 h-8">
                            <option value="">Hepsi</option>
                            <option value="Konut">Konut</option>
                            <option value="İş Yeri">İş Yeri</option>
                        </select></div>
                    <div class="w-20 shrink-0"><label
                            class="label-text block mb-1 ml-1 text-[9px] uppercase tracking-wider opacity-70">Oda</label><input
                            type="text" id="filter-rooms" oninput="APP.render.hunter()"
                            class="input-alpha text-[10px] py-1.5 px-2 h-8" placeholder="3+1"></div>
                    <div class="w-24 shrink-0"><label
                            class="label-text block mb-1 ml-1 text-[9px] uppercase tracking-wider opacity-70">Min
                            ₺</label><input type="number" id="filter-min-price" oninput="APP.render.hunter()"
                            class="input-alpha text-[10px] py-1.5 px-2 h-8"></div>
                    <div class="w-24 shrink-0"><label
                            class="label-text block mb-1 ml-1 text-[9px] uppercase tracking-wider opacity-70">Max
                            ₺</label><input type="number" id="filter-max-price" oninput="APP.render.hunter()"
                            class="input-alpha text-[10px] py-1.5 px-2 h-8"></div>
                    <button onclick="APP.render.hunter()"
                        class="h-8 w-8 bg-brand-500 text-white rounded-lg text-[10px] font-bold uppercase active:scale-95 flex items-center justify-center shadow-lg"><i
                            class="fa-solid fa-filter"></i></button>
                    <div class="ml-auto text-[9px] text-slate-500 font-mono self-center pt-4" id="hunter-count"></div>
                </div>
                <div id="hunter-list" class="grid grid-cols-1 gap-3"></div>
            </div>

            <!-- VIEW: CRM -->
            <div id="view-crm" class="hidden animate-fade-in space-y-4">
                <div id="crm-list" class="grid grid-cols-1 gap-3"></div>
            </div>

            <div id="view-portfolio" class="hidden animate-fade-in space-y-4">
                <div id="portfolio-list" class="grid grid-cols-1 gap-3"></div>
            </div>

            <!-- VIEW: MAP DUPLICATE REMOVED -->

            <!-- VIEW: TAKVİM -->
            <div id="view-randevular" class="hidden animate-fade-in">
                <div id="appointment-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>

            <!-- VIEW: AJANDA / HATIRLATMALAR -->
            <div id="view-reminders" class="hidden animate-fade-in space-y-6">
                <div class="flex justify-between items-center bg-glass p-4 rounded-xl border border-white/10">
                    <h2 class="text-xl font-bold text-white flex items-center gap-3">
                        <i class="fa-solid fa-bell text-brand-400"></i> Ajanda & Ödemeler
                    </h2>
                </div>
                <!-- Reminders List -->
                <div id="reminders-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- JS Fill -->
                </div>
            </div>

            <!-- VIEW: DİJİTAL ARŞİV (YENİ) -->
            <div id="view-archive" class="hidden animate-fade-in space-y-6">
                <div class="flex justify-between items-center bg-glass p-4 rounded-xl border border-white/10">
                    <h2 class="text-xl font-bold text-white flex items-center gap-3">
                        <i class="fa-solid fa-folder-tree text-brand-400"></i> Dijital Arşiv
                    </h2>
                    <button onclick="APP.modals.openArchiveUpload()"
                        class="px-5 py-2 bg-brand-500 hover:bg-brand-600 text-white rounded-xl text-[10px] font-bold uppercase transition shadow-lg flex items-center gap-2">
                        <i class="fa-solid fa-cloud-arrow-up"></i> Yeni Belge Ekle
                    </button>
                </div>

                <!-- Arşiv Grid -->
                <div id="archive-list" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
                    <!-- JS ile doldurulacak -->
                </div>
            </div>

            <!-- VIEW: AI HUB -->
            <div id="view-ai-hub" class="hidden animate-fade-in space-y-6 text-white">
                <div class="grid grid-cols-2 gap-6">
                    <!-- Cards Omitted for brevity, unchanged -->
                    <div class="glass-card p-6 rounded-2xl border-accent-ai/20">
                        <div class="w-10 h-10 bg-accent-ai/10 rounded-xl flex items-center justify-center mb-4"><i
                                class="fa-solid fa-calculator text-accent-ai text-lg"></i></div>
                        <h3 class="text-lg font-bold text-white mb-1 uppercase">Fiyat Tahminleme</h3>
                        <p class="text-xs text-slate-400 mb-4 leading-relaxed">Excel listesini baz alarak bölgenin net
                            pazar değerini sunar.</p><button onclick="APP.ai.runEngine('price')"
                            class="w-full py-3 bg-accent-ai/20 text-accent-ai rounded-xl text-[10px] font-bold uppercase border border-accent-ai/30 hover:bg-accent-ai transition">Analizi
                            Başlat</button>
                    </div>
                    <!-- ... other cards ... -->
                    <div class="glass-card p-6 rounded-2xl border-brand-500/20">
                        <div class="w-10 h-10 bg-brand-500/10 rounded-xl flex items-center justify-center mb-4"><i
                                class="fa-solid fa-gauge-simple-high text-brand-400 text-lg"></i></div>
                        <h3 class="text-lg font-bold text-white mb-1 uppercase">Satış Hızı</h3>
                        <p class="text-xs text-slate-400 mb-4 leading-relaxed">Excel verilerindeki değişim tarihlerine
                            göre sirkülasyon hızı hesaplar.</p><button onclick="APP.ai.runEngine('speed')"
                            class="w-full py-3 bg-brand-500/20 text-brand-400 rounded-xl text-[10px] font-bold uppercase border border-brand-500/30 hover:bg-brand-500 transition">Hız
                            Analizi</button>
                    </div>
                    <div class="glass-card p-6 rounded-2xl border-accent-primary/20">
                        <div class="w-10 h-10 bg-accent-primary/10 rounded-xl flex items-center justify-center mb-4"><i
                                class="fa-solid fa-money-bill-trend-up text-accent-primary text-lg"></i></div>
                        <h3 class="text-lg font-bold text-white mb-1 uppercase">ROI & Amortisman</h3>
                        <p class="text-xs text-slate-400 mb-4 leading-relaxed">Satılık ve Kiralık Excel dosyalarını
                            çaprazlayarak geri dönüşü hesaplar.</p><button onclick="APP.ai.runEngine('roi')"
                            class="w-full py-3 bg-accent-primary/20 text-accent-primary rounded-xl text-[10px] font-bold uppercase border border-accent-primary/30 hover:bg-accent-primary transition">ROI
                            Raporu</button>
                    </div>
                    <div class="glass-card p-6 rounded-2xl border-accent-danger/20">
                        <div class="w-10 h-10 bg-accent-danger/10 rounded-xl flex items-center justify-center mb-4"><i
                                class="fa-solid fa-clock-rotate-left text-accent-danger text-lg"></i></div>
                        <h3 class="text-lg font-bold text-white mb-1 uppercase">Arama Takibi</h3>
                        <p class="text-xs text-slate-400 mb-4 leading-relaxed">1 aylık yayın süresi dolmak üzere olan
                            ilanları tespit eder.</p><button onclick="APP.ai.runEngine('expiry')"
                            class="w-full py-3 bg-accent-danger/20 text-accent-danger rounded-xl text-[10px] font-bold uppercase border border-accent-danger/30 hover:bg-accent-danger transition">Takip
                            Listesi</button>
                    </div>
                </div>
            </div>
            <!-- ... -->

            <!-- MODAL: MANUEL KAYIT UNCHANGED -->

            <!-- MODAL CRM UPDATE -->
            <div id="modal-crm"
                class="fixed inset-0 bg-black/90 z-[110] hidden flex items-center justify-center p-6 text-white">
                <div class="glass bg-[#0f172a] w-full max-w-lg rounded-[30px] p-8 border border-slate-700 shadow-2xl">
                    <h3 class="text-lg font-bold text-white mb-5 uppercase tracking-tight" id="crm-modal-title">Görüşme
                        Kaydı
                    </h3>
                    <div class="space-y-4">
                        <div class="flex gap-4">
                            <div class="flex-1">
                                <label class="label-text mb-1 block">Telefon Numarası</label>
                                <input type="text" id="crm-phone" class="input-alpha" placeholder="05XX XXX XX XX">
                            </div>
                            <div class="flex-1">
                                <label class="label-text mb-1 block">Durum</label>
                                <select id="crm-status" class="input-alpha">
                                    <option value="Görüşülüyor">Görüşülüyor</option>
                                    <option value="Arandı">Arandı (Cevap Yok)</option>
                                    <option value="Teklif">Teklif Verildi</option>
                                    <option value="Randevu">Randevu Alındı</option>
                                    <option value="Satıldı">Satıldı</option>
                                    <option value="İptal">İptal</option>
                                </select>
                            </div>
                        </div>

                        <div><label class="label-text mb-1 block">Notlar</label><textarea id="crm-note"
                                class="input-alpha h-24 resize-none" placeholder="Notları buraya girin..."></textarea>
                        </div>

                        <div><label class="label-text mb-1 block">Randevu / Hatırlatıcı</label><input
                                type="datetime-local" id="crm-date" class="input-alpha"></div>

                        <!-- History View -->
                        <div class="mt-4">
                            <label
                                class="label-text mb-2 block uppercase text-[10px] tracking-widest opacity-50">Görüşme
                                Geçmişi</label>
                            <div id="crm-history-list" class="max-h-32 overflow-y-auto space-y-2 pr-2 custom-scrollbar">
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="document.getElementById('modal-crm').classList.add('hidden')"
                                class="flex-1 py-3 bg-white/5 text-slate-400 rounded-xl text-[10px] font-bold uppercase">İPTAL</button>
                            <button onclick="APP.actions.saveCrm()"
                                class="flex-1 py-3 bg-brand-500 text-white rounded-xl text-[10px] font-bold uppercase active:scale-95">KAYDET</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODAL: MANUEL KAYIT / DUZENLE -->
    <div id="modal-manual"
        class="fixed inset-0 bg-black/95 z-[100] hidden flex items-center justify-center p-6 text-white">
        <div
            class="glass bg-[#0f172a] w-full max-w-4xl rounded-[30px] p-8 border border-slate-700 shadow-2xl flex flex-col max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold text-white mb-6 uppercase text-center tracking-widest italic"
                id="manual-modal-title">Manuel İlan Kaydı</h3>
            <div class="grid grid-cols-2 gap-5">
                <div class="space-y-3">
                    <div><label class="label-text block mb-1">İlan Başlığı</label><input type="text" id="m-title"
                            class="input-alpha"></div>
                    <div><label class="label-text block mb-1">İlan No</label><input type="text" id="m-no"
                            class="input-alpha"></div>
                    <div><label class="label-text block mb-1">Fiyat (TL)</label><input type="number" id="m-price"
                            class="input-alpha"></div>
                    <div><label class="label-text block mb-1">Konum</label><input type="text" id="m-loc"
                            class="input-alpha"></div>
                    <div><label class="label-text block mb-1">m²</label><input type="text" id="m-m2"
                            class="input-alpha"></div>
                    <div><label class="label-text block mb-1">Yayın Tarihi</label><input type="date" id="m-date"
                            class="input-alpha"></div>
                </div>
                <div class="space-y-3">
                    <div><label class="label-text block mb-1">Oda Sayısı</label><input type="text" id="m-rooms"
                            class="input-alpha"></div>
                    <div><label class="label-text block mb-1">Bulunduğu Kat</label><input type="text" id="m-floor"
                            class="input-alpha"></div>
                    <div><label class="label-text block mb-1">Tip</label><select id="m-type" class="input-alpha">
                            <option value="Konut">Konut</option>
                            <option value="İş Yeri">İş Yeri</option>
                        </select></div>
                    <div><label class="label-text block mb-1">Kimden</label><select id="m-from" class="input-alpha">
                            <option value="Excel">Excel</option>
                            <option value="Emlak Ofisi">Emlak Ofisi</option>
                        </select></div>
                    <div><label class="label-text block mb-1">Telefon / İletişim</label><input type="text" id="m-phone"
                            class="input-alpha"></div>
                </div>
            </div>
            <div class="flex gap-3 mt-8">
                <button onclick="document.getElementById('modal-manual').classList.add('hidden')"
                    class="flex-1 py-3 bg-white/5 text-slate-400 rounded-xl text-[10px] font-bold uppercase tracking-widest">İPTAL</button>
                <button onclick="APP.actions.saveManual()"
                    class="flex-1 py-3 bg-brand-500 text-white rounded-xl text-[10px] font-bold uppercase shadow-xl active:scale-95">KAYDET</button>
            </div>
        </div>
    </div>

    <!-- Duplicate Modal Removed -->

    <!-- MODAL: DİJİTAL ARŞİV (YENİ YAPILANDIRILMIŞ) -->
    <div id="modal-archive"
        class="fixed inset-0 bg-black/95 z-[120] hidden flex items-center justify-center p-6 text-white">
        <div
            class="glass bg-[#0f172a] w-full max-w-md rounded-[30px] p-8 border border-brand-500/30 shadow-2xl relative overflow-hidden">
            <!-- Dekoratif Arkaplan -->
            <div class="absolute -top-10 -right-10 w-32 h-32 bg-brand-500/20 rounded-full blur-3xl"></div>

            <h3 class="text-lg font-bold text-white mb-6 uppercase tracking-widest flex items-center gap-2">
                <i class="fa-solid fa-cloud-arrow-up text-brand-400"></i> Dosya Arşivle
            </h3>

            <div class="space-y-4">
                <!-- 1. Dosya Seçimi -->
                <div class="p-4 bg-black/40 rounded-xl border border-white/5 text-center transition hover:border-brand-500/50 cursor-pointer group"
                    onclick="APP.actions.triggerFileSelect()">
                    <i
                        class="fa-solid fa-file-pdf text-3xl text-slate-600 group-hover:text-brand-400 mb-2 transition"></i>
                    <p class="text-[10px] text-slate-400 font-bold uppercase">Dosya Seçmek İçin Tıklayın</p>
                    <p id="arc-file-label"
                        class="text-[9px] text-brand-400 mt-2 truncate font-mono opacity-0 transition-opacity">Dosya
                        seçilmedi</p>
                </div>

                <!-- 2. Arşiv Bilgileri (Klasörleme İçin) -->
                <div>
                    <label class="label-text mb-1 block text-brand-400">İşlem Türü (Ana Klasör)</label>
                    <select id="arc-type" class="input-alpha text-white bg-slate-900">
                        <option value="Satış">Satış</option>
                        <option value="Kiralama">Kiralama</option>
                        <option value="Tapu">Tapu Evrakları</option>
                        <option value="Sözleşmeler">Sözleşmeler</option>
                        <option value="Diğer">Diğer</option>
                    </select>
                </div>

                <div>
                    <label class="label-text mb-1 block text-brand-400">İşlem Tarihi</label>
                    <input type="date" id="arc-date" class="input-alpha">
                </div>

                <div>
                    <label class="label-text mb-1 block text-brand-400">Müşteri / Dosya Adı</label>
                    <input type="text" id="arc-name" class="input-alpha" placeholder="Örn: Ahmet Yılmaz - Daire 5">
                </div>

                <div>
                    <label class="label-text mb-1 block text-brand-400">Tutar (Varsa)</label>
                    <input type="number" id="arc-amount" class="input-alpha" placeholder="0">
                </div>

                <input type="hidden" id="arc-path">

                <div class="flex gap-3 mt-6">
                    <button onclick="document.getElementById('modal-archive').classList.add('hidden')"
                        class="flex-1 py-3 bg-white/5 text-slate-400 rounded-xl text-[10px] font-bold uppercase">İptal</button>
                    <button onclick="APP.actions.saveArchive()"
                        class="flex-1 py-3 bg-brand-500 text-white rounded-xl text-[10px] font-bold uppercase shadow-xl active:scale-95 hover:bg-brand-400 transition">
                        Arşivle & Klasörle
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        window.APP = {
            allData: [], crmEntries: {}, portfolioData: [], successData: [],
            charts: {}, // FIX: Initialize charts object
            newAddedCount: 0, deletedCount: 0,
            activeListingNo: null, activeManualMode: 'add',
            hunterListingNoFilter: null, // New filter for hunter view

            init: async function () {
                // SPLASH START
                const splashBar = document.getElementById('splash-bar');
                if (splashBar) splashBar.style.width = '100%';

                // CLOCK
                setInterval(() => {
                    const el = document.getElementById('current-time');
                    if (el) el.innerText = new Date().toLocaleTimeString();
                }, 1000);

                // API READY CHECK & LOAD
                const checkApi = setInterval(async () => {
                    if (window.pywebview?.api) {
                        clearInterval(checkApi);
                        await this.loadPersistedData();

                        // Load Archives after data
                        setTimeout(() => this.loadArchives(), 1000);
                    }
                }, 100);

                // REMOVE SPLASH
                setTimeout(() => {
                    const splash = document.getElementById('splash-screen');
                    if (splash) {
                        splash.style.opacity = '0';
                        splash.style.pointerEvents = 'none';
                        setTimeout(() => splash.classList.add('hidden'), 800);
                    }
                }, 2500);
            },

            loadPersistedData: async function () {
                try {
                    const dbRaw = await window.pywebview.api.load_data('alpha_database');
                    if (dbRaw && dbRaw !== "[]") this.allData = JSON.parse(dbRaw);

                    const crmRaw = await window.pywebview.api.load_data('crm_db');
                    this.crmEntries = JSON.parse(crmRaw || '{}');
                    if (Array.isArray(this.crmEntries)) this.crmEntries = {};

                    const portRaw = await window.pywebview.api.load_data('portfolio_db');
                    this.portfolioData = JSON.parse(portRaw || '[]');

                    const succRaw = await window.pywebview.api.load_data('success_db');
                    this.successData = JSON.parse(succRaw || '[]');

                    this.render.all();
                    window.pywebview.api.start_sync();
                } catch (e) { console.error("Persistence Load Error:", e); }
            },



            receiveData: function (newData) {
                if (this.allData && this.allData.length > 0) {
                    const oldIds = new Set(this.allData.map(x => String(x.listingNo)));
                    const newIds = new Set(newData.map(x => String(x.listingNo)));
                    this.newAddedCount = newData.filter(x => !oldIds.has(String(x.listingNo))).length;
                    this.deletedCount = this.allData.filter(x => !newIds.has(String(x.listingNo))).length;
                }
                this.allData = newData || [];
                this.render.all();
            },

            nav: function (v) {
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('nav-' + v)?.classList.add('active');
                document.querySelectorAll('main > div').forEach(d => d.classList.add('hidden'));
                document.getElementById('view-' + v)?.classList.remove('hidden');

                if (v === 'hunter') {
                    this.render.hunter();
                    // Check filter
                    if (this.hunterListingNoFilter) {
                        const filterId = this.hunterListingNoFilter;
                        this.hunterListingNoFilter = null; // Clear
                        setTimeout(() => {
                            const el = document.getElementById('listing-' + filterId);
                            if (el) {
                                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                el.classList.add('ring-2', 'ring-brand-500', 'bg-brand-500/10');
                                setTimeout(() => el.classList.remove('ring-2', 'ring-brand-500', 'bg-brand-500/10'), 3000);
                            }
                        }, 500); // Wait for render
                    }
                }
                if (v === 'crm') this.render.crm();

                // Map resize fix REMOVED

                this.render.all();
            },

            modals: {
                openManual: function (mode, item = null) {
                    window.APP.activeManualMode = mode;
                    document.getElementById('manual-modal-title').innerText = mode === 'edit' ? 'İlan Düzenle' : 'Manuel İlan Kaydı';

                    if (item) {
                        document.getElementById('m-title').value = item.title || '';
                        document.getElementById('m-no').value = item.listingNo || '';
                        document.getElementById('m-price').value = item.price || 0;
                        document.getElementById('m-loc').value = item.location || '';
                        document.getElementById('m-m2').value = item.m2 || '';
                        document.getElementById('m-rooms').value = item.rooms || '';
                        document.getElementById('m-floor').value = item.floor || '';
                        document.getElementById('m-type').value = item.type || 'Konut';
                        document.getElementById('m-from').value = item.from || 'Excel';
                        document.getElementById('m-phone').value = item.phone || '';
                        if (item.date) document.getElementById('m-date').value = item.date.split('T')[0];
                    } else {
                        ['m-title', 'm-no', 'm-price', 'm-loc', 'm-m2', 'm-rooms', 'm-floor', 'm-phone'].forEach(f => document.getElementById(f).value = '');
                        document.getElementById('m-date').valueAsDate = new Date();
                    }
                    document.getElementById('modal-manual').classList.remove('hidden');
                },
                openCrm: function (no, isEdit = false) {
                    window.APP.activeListingNo = no;
                    document.getElementById('crm-modal-title').innerText = isEdit ? 'Görüşmeyi Düzenle' : 'Görüşme Kaydı #' + no;
                    const entry = window.APP.crmEntries[no] || { note: '', date: '', history: [] };
                    const item = (window.APP.allData || []).find(d => String(d.listingNo) === String(no));

                    document.getElementById('crm-note').value = ''; // Always clear for new note
                    document.getElementById('crm-date').value = entry.date || '';
                    document.getElementById('crm-status').value = entry.status || 'Görüşülüyor';

                    // Telefon Numarası Logic:
                    // 1. Varsa ilanın kendisinden çek. 2. Yoksa CRM kaydından çek (varsa).
                    const phone = (item && item.phone) ? item.phone : (entry.phone || '');
                    document.getElementById('crm-phone').value = phone;

                    // Render History
                    const hList = document.getElementById('crm-history-list');
                    if (hList) {
                        const hist = entry.history || (entry.note ? [{ date: 'Eski', note: entry.note, status: '-' }] : []);
                        hList.innerHTML = hist.map(h => `
                            <div class="p-2 bg-white/5 rounded border border-white/5">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-[9px] text-brand-400 font-bold">${h.status || '-'}</span>
                                    <span class="text-[8px] text-slate-500">${h.date}</span>
                                </div>
                                <p class="text-[10px] text-slate-300 italic">${h.note}</p>
                            </div>
                        `).join('') || '<p class="text-[9px] text-slate-600 text-center">Henüz geçmiş yok.</p>';
                    }

                    document.getElementById('modal-crm').classList.remove('hidden');
                }
            },

            render: {
                all: function () {
                    this.dashboard(); this.hunter(); this.crm(); this.portfolio(); this.randevular(); this.reminders(); this.chart();
                },

                dashboard: function () {
                    // Stats
                    const data = window.APP.allData || [];
                    document.getElementById('stat-total').innerText = data.length;
                    document.getElementById('stat-valuation').innerText = (data.reduce((a, b) => a + (parseInt(b.price) || 0), 0) / 1000000).toFixed(1) + 'M ₺';
                    document.getElementById('stat-new-added').innerText = window.APP.newAddedCount || 0;
                    document.getElementById('stat-deleted').innerText = window.APP.deletedCount || 0;
                    document.getElementById('stat-success-count').innerText = window.APP.successData.length;
                    document.getElementById('stat-crm').innerText = Object.keys(window.APP.crmEntries).length;
                    document.getElementById('stat-randevu').innerText = Object.values(window.APP.crmEntries).filter(x => x.appointment).length;
                    document.getElementById('stat-portfolio').innerText = window.APP.portfolioData.length;

                    // Chart Logic Moved to APP.render.chart() to avoid Canvas Collisions
                    this.chart();


                    // Render Randevular (Mini)
                    const miniRandevu = document.getElementById('dash-randevu-list');
                    if (miniRandevu) {
                        const apps = Object.values(window.APP.crmEntries).filter(x => x.date && x.date !== '').sort((a, b) => a.date.localeCompare(b.date)).slice(0, 5);
                        miniRandevu.innerHTML = apps.map(app => `
                             <div class="flex items-center gap-3 p-3 bg-white/5 rounded-xl border border-white/5">
                                 <div class="w-8 h-8 rounded-full bg-accent-secondary/20 text-accent-secondary flex items-center justify-center text-xs"><i class="fa-solid fa-calendar"></i></div>
                                 <div class="flex-1 min-w-0">
                                     <p class="text-[10px] text-white font-bold truncate">${app.date.replace('T', ' ')}</p>
                                     <p class="text-[9px] text-slate-400 truncate">${app.note}</p>
                                 </div>
                             </div>
                        `).join('') || '<p class="text-center text-slate-600 text-[10px] py-4">Randevu yok</p>';
                    }

                    // Render AI Advice (Interactive)
                    const aiAdvice = document.getElementById('dash-ai-advice');
                    if (aiAdvice) {
                        // Basit "Fırsat" Algoritması (Dashboard Teaser)
                        // Fiyat/m2 oranı en düşük 3 ilan
                        let potential = [...data]
                            .filter(x => parseInt(x.price) > 0 && parseInt(x.m2) > 0)
                            .map(x => ({ ...x, unitPrice: parseInt(x.price) / parseInt(x.m2) }))
                            .sort((a, b) => a.unitPrice - b.unitPrice)
                            .slice(0, 3);

                        if (potential.length > 0) {
                            aiAdvice.innerHTML = potential.map(p => `
                                <div onclick="APP.actions.filterListing('${p.listingNo}')" class="p-4 rounded-xl border border-accent-ai/20 bg-accent-ai/5 hover:bg-accent-ai/10 cursor-pointer transition group relative overflow-hidden">
                                    <div class="absolute top-0 right-0 p-1"><i class="fa-solid fa-arrow-right text-accent-ai opacity-0 group-hover:opacity-100 transition -translate-x-2 group-hover:translate-x-0 text-xs"></i></div>
                                    <h4 class="text-[9px] uppercase font-bold text-accent-ai mb-1 tracking-wider">FIRSAT: ${p.listingNo}</h4>
                                    <p class="text-[10px] text-slate-300">Bölge ortalamasına göre m² avantajlı.</p>
                                    <div class="mt-2 text-[10px] font-mono text-white bg-black/20 inline-block px-2 py-0.5 rounded">${parseInt(p.price).toLocaleString()} ₺</div>
                                </div>
                            `).join('');
                        } else {
                            aiAdvice.innerHTML = '<p class="text-center text-slate-500 text-[10px] py-4">Yeterli veri yok</p>';
                        }
                    }
                },

                hunter: function () {
                    const list = document.getElementById('hunter-list');
                    if (!list) return;

                    // GET FILTERS
                    const lType = document.getElementById('filter-listing-type').value;
                    const type = document.getElementById('filter-type').value;
                    const roomVal = (document.getElementById('filter-rooms').value || '').toLowerCase();
                    const minP = parseFloat(document.getElementById('filter-min-price').value) || 0;
                    const maxP = parseFloat(document.getElementById('filter-max-price').value) || Infinity;
                    const listingNoFilter = window.APP.hunterListingNoFilter; // Get the new filter

                    // FILTER LOGIC
                    const filtered = (window.APP.allData || []).filter(item => {
                        // 1. Listing Type (Hepsi check)
                        const lMatch = !lType || lType === "" || item.listingType === lType;

                        // 2. Property Type (Hepsi check)
                        const tMatch = !type || type === "" || item.type === type;

                        // 3. Rooms (Partial match)
                        let rMatch = true;
                        if (roomVal) {
                            rMatch = (item.rooms || '').toLowerCase().includes(roomVal);
                        }

                        // 4. Price Range
                        const price = parseInt(item.price) || 0;
                        const pMatch = price >= minP && (maxP === Infinity || price <= maxP);

                        // 5. Listing No Filter
                        const noMatch = !listingNoFilter || String(item.listingNo) === String(listingNoFilter);

                        return lMatch && tMatch && rMatch && pMatch && noMatch;
                    });

                    // RENDER
                    // New Detailed Card Design
                    list.innerHTML = filtered.map(item => `
                        <div class="glass-card flex items-stretch overflow-hidden rounded-2xl group border-white/5 hover:border-brand-500/30 transition-all duration-300">
                             
                             <!-- Left: Visual / Icon -->
                             <div class="w-24 bg-gradient-to-br from-slate-800 to-black/50 flex flex-col items-center justify-center p-2 relative">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center mb-1 ${item.listingType === 'Satılık' ? 'bg-brand-500/20 text-brand-400' : 'bg-accent-secondary/20 text-accent-secondary'}">
                                    <i class="fa-solid fa-${item.type === 'Konut' ? 'home' : 'building'}"></i>
                                </div>
                                <span class="text-[9px] font-bold uppercase tracking-wider text-white/50">${item.listingType}</span>
                             </div>

                             <!-- Center: Info -->
                             <div class="flex-1 p-4 grid grid-cols-12 gap-4">
                                <div class="col-span-12 md:col-span-8">
                                    <div class="flex items-center gap-2 mb-1">
                                        <h4 class="font-bold text-white text-sm line-clamp-1">${item.title}</h4>
                                        <button onclick="APP.actions.copyId('${item.listingNo}')" class="text-[9px] bg-white/5 hover:bg-white/20 text-slate-400 hover:text-white px-2 py-0.5 rounded transition"><i class="fa-solid fa-copy mr-1"></i>#${item.listingNo}</button>
                                    </div>
                                    <div class="flex items-center gap-4 text-[10px] text-slate-400 mb-2">
                                        <span><i class="fa-solid fa-location-dot text-brand-500/70 mr-1"></i> ${item.location}</span>
                                        <span><i class="fa-solid fa-layer-group text-slate-600 mr-1"></i> ${item.m2} m²</span>
                                        <span><i class="fa-solid fa-door-open text-slate-600 mr-1"></i> ${item.rooms}</span>
                                    </div>
                                    <div class="flex gap-2">
                                         ${item.status === 'Fiyat Düştü' ? '<span class="px-2 py-0.5 bg-accent-primary/20 text-accent-primary text-[9px] rounded font-bold uppercase">Fiyat Düştü</span>' : ''}
                                         ${item.status === 'Fiyat Arttı' ? '<span class="px-2 py-0.5 bg-accent-danger/20 text-accent-danger text-[9px] rounded font-bold uppercase">Fiyat Arttı</span>' : ''}
                                    </div>
                                </div>
                                <div class="col-span-12 md:col-span-4 flex flex-col items-end justify-center">
                                    <span class="text-lg font-bold text-white tracking-tighter">${parseInt(item.price).toLocaleString()} ₺</span>
                                    <span class="text-[9px] text-slate-500 font-mono">${item.date ? item.date.split('T')[0] : 'Tarih Yok'}</span>
                                </div>
                             </div>

                             <!-- Right: Actions -->
                             <div class="w-14 border-l border-white/5 bg-white/[0.02] flex flex-col items-center justify-center gap-2 p-2">
                                <button onclick="APP.modals.openCrm('${item.listingNo}')" class="w-8 h-8 rounded-lg bg-indigo-500/20 text-indigo-400 hover:bg-indigo-500 hover:text-white transition flex items-center justify-center shadow-lg"><i class="fa-solid fa-phone"></i></button>
                                <button onclick="APP.actions.addToPortfolio('${item.listingNo}')" class="w-8 h-8 rounded-lg bg-brand-500/20 text-brand-400 hover:bg-brand-500 hover:text-white transition flex items-center justify-center shadow-lg"><i class="fa-solid fa-briefcase"></i></button>
                             </div>
                        </div>
                    `).join('') || '<p class="text-center opacity-20 py-10 text-[11px] font-bold uppercase text-white tracking-widest">Sonuç bulunamadı.</p>';
                },

                crm: function () {
                    const list = document.getElementById('crm-list');
                    if (!list) return;
                    const handled = Object.keys(window.APP.crmEntries);

                    if (handled.length === 0) {
                        list.innerHTML = '<p class="text-center opacity-10 py-10 font-bold uppercase text-[10px] text-white tracking-widest">Görüşme Kaydı Bulunmuyor</p>';
                        return;
                    }

                    list.innerHTML = handled.map(no => {
                        const itm = (window.APP.allData || []).find(d => String(d.listingNo) === String(no));
                        if (itm) {
                            return this.cardTemplate(itm, 'crm');
                        } else {
                            // Fallback for partial data
                            return `<div class="glass-card p-4 rounded-xl text-white">Veri Bulunamadı #${no}</div>`;
                        }
                    }).join('');
                },

                portfolio: function () {
                    const list = document.getElementById('portfolio-list');
                    if (list) list.innerHTML = window.APP.portfolioData.map(item => this.cardTemplate(item, 'portfolio')).join('') || '<p class="text-center opacity-10 py-10 font-bold uppercase text-[10px] text-white tracking-widest">Portföy Henüz Boş</p>';
                },

                randevular: function () {
                    const list = document.getElementById('appointment-list');
                    if (!list) return;
                    const apps = Object.values(window.APP.crmEntries).filter(x => x.date && x.date !== '').sort((a, b) => a.date.localeCompare(b.date));
                    list.innerHTML = apps.map(app => {
                        const itm = (window.APP.allData || []).find(d => String(d.listingNo) === String(app.listingNo)) || { title: 'Manuel Kayıt' };
                        return `<div class="glass-card p-5 rounded-2xl border-accent-secondary/30 animate-fade-in shadow-xl relative group">
                            <div class="absolute top-4 right-4 opacity-0 group-hover:opacity-100 transition-all flex gap-2">
                                <button onclick="APP.modals.openCrm('${app.listingNo}', true)" class="action-icon btn-edit w-6 h-6 text-[10px]"><i class="fa-solid fa-pen"></i></button>
                                <button onclick="APP.actions.deleteRandevu('${app.listingNo}')" class="action-icon btn-delete w-6 h-6 text-[10px]"><i class="fa-solid fa-trash"></i></button>
                            </div>
                            <span class="px-3 py-1 bg-accent-secondary text-white text-[9px] font-bold rounded-lg mb-3 inline-block shadow-md">${app.date.replace('T', ' ')}</span>
                            <h4 class="text-xs font-bold text-white uppercase mb-2 tracking-tight truncate pr-12">${itm.title}</h4>
                            <p class="text-[11px] text-slate-400 italic bg-dark-950 p-3 rounded-lg border border-white/5 line-clamp-2">${app.note}</p>
                        </div>`;
                    }).join('') || '<p class="col-span-full text-center opacity-10 py-10 font-bold text-[10px] text-white tracking-widest">Planlanmış Randevu Yok</p>';
                },

                map: function () {
                    if (!document.getElementById('map-container')) return;

                    // CONSTANTS
                    const CITY_CENTER = { lat: 39.7767, lng: 30.5206 };
                    // Önemli Merkezler (Referans Noktaları)
                    const ESK_COORDS = {
                        'Vişnelik': { lat: 39.758, lng: 30.505 }, 'Sümer': { lat: 39.768, lng: 30.495 }, 'Kırmızıtoprak': { lat: 39.762, lng: 30.515 },
                        'Osmangazi': { lat: 39.755, lng: 30.485 }, 'Akarbaşı': { lat: 39.760, lng: 30.525 }, 'Büyükdere': { lat: 39.745, lng: 30.495 },
                        'Göztepe': { lat: 39.745, lng: 30.515 }, 'Gültepe': { lat: 39.735, lng: 30.530 }, 'Yıldıztepe': { lat: 39.740, lng: 30.535 },
                        'Yenidoğan': { lat: 39.755, lng: 30.540 }, 'Emek': { lat: 39.750, lng: 30.560 }, '71 Evler': { lat: 39.755, lng: 30.585 },
                        'Gökmeydan': { lat: 39.762, lng: 30.550 }, 'Erenköy': { lat: 39.740, lng: 30.560 }, 'Kurtuluş': { lat: 39.768, lng: 30.530 },
                        'Deliklitaş': { lat: 39.772, lng: 30.535 }, 'Huzur': { lat: 39.740, lng: 30.580 }, 'Orhangazi': { lat: 39.745, lng: 30.505 },
                        'Vadişehir': { lat: 39.730, lng: 30.485 }, 'Ihlamurkent': { lat: 39.720, lng: 30.500 },
                        // TEPEBAŞI
                        'Hoşnudiye': { lat: 39.782, lng: 30.518 }, 'Eskibağlar': { lat: 39.785, lng: 30.508 }, 'Yenibağlar': { lat: 39.788, lng: 30.505 },
                        'Güllük': { lat: 39.790, lng: 30.515 }, 'Bahçelievler': { lat: 39.785, lng: 30.495 }, 'Uluönder': { lat: 39.795, lng: 30.500 },
                        'Şirintepe': { lat: 39.800, lng: 30.490 }, 'Zincirlikuyu': { lat: 39.810, lng: 30.480 }, 'Ertuğrulgazi': { lat: 39.800, lng: 30.470 },
                        'Sazova': { lat: 39.785, lng: 30.460 }, 'Batıkent': { lat: 39.800, lng: 30.450 }, 'Çamlıca': { lat: 39.780, lng: 30.480 },
                        'Sütlüce': { lat: 39.805, lng: 30.530 }, 'Yeşiltepe': { lat: 39.800, lng: 30.540 }, 'Şarhöyük': { lat: 39.795, lng: 30.550 },
                        'Fevzi Çakmak': { lat: 39.790, lng: 30.560 }, 'Zafer': { lat: 39.785, lng: 30.555 }, 'Tunalı': { lat: 39.780, lng: 30.545 },
                        'Ömerağa': { lat: 39.785, lng: 30.535 }, 'Mamure': { lat: 39.775, lng: 30.535 }, 'Işıklar': { lat: 39.775, lng: 30.545 }
                    };

                    // INIT MAP
                    if (!window.APP.mapInstance) {
                        try {
                            window.APP.mapInstance = L.map('map-container', {
                                attributionControl: false, zoomControl: false, dragging: true,
                                touchZoom: true, doubleClickZoom: true, scrollWheelZoom: true,
                                preferCanvas: true
                            }).setView(CITY_CENTER, 14);

                            const southWest = L.latLng(39.70, 30.30);
                            const northEast = L.latLng(39.85, 30.70);
                            window.APP.mapInstance.setMaxBounds(L.latLngBounds(southWest, northEast));
                            window.APP.mapInstance.setMinZoom(13);

                            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                                subdomains: 'abcd', maxZoom: 20
                            }).addTo(window.APP.mapInstance);

                            window.APP.mapMarkers = L.layerGroup().addTo(window.APP.mapInstance);
                            window.APP.mapLabels = L.layerGroup().addTo(window.APP.mapInstance);

                            setTimeout(() => { window.APP.mapInstance.invalidateSize(); }, 500);
                        } catch (e) { console.error(e); return; }
                    }

                    // --- TECH LABELS (HOLLOW NEON + LINE) ---
                    window.APP.mapLabels.clearLayers();
                    for (const [name, coords] of Object.entries(ESK_COORDS)) {
                        const labelHtml = `
                            <div class="tech-label-container" style="position: relative; width: 0; height: 0;">
                                <div class="tech-line" style="
                                    position: absolute; 
                                    bottom: 0; left: 0; 
                                    width: 1px; height: 30px; 
                                    background: linear-gradient(to top, rgba(14,165,233,0.8), transparent);
                                    transform: translateX(-50%);
                                "></div>
                                <div class="tech-text" style="
                                    position: absolute; 
                                    bottom: 30px; left: 50%; 
                                    transform: translateX(-50%);
                                    font-family: 'Rajdhani', sans-serif;
                                    font-size: 16px; 
                                    font-weight: 800; 
                                    letter-spacing: 1px;
                                    color: transparent;
                                    -webkit-text-stroke: 1px rgba(14,165,233, 0.9);
                                    text-shadow: 0 0 10px rgba(14,165,233, 0.4);
                                    white-space: nowrap;
                                    pointer-events: none;
                                ">${name.toUpperCase()}</div>
                            </div>`;

                        const labelIcon = L.divIcon({ className: 'bg-transparent', html: labelHtml, iconSize: [0, 0], iconAnchor: [0, 0] });
                        L.marker([coords.lat, coords.lng], { icon: labelIcon, interactive: false }).addTo(window.APP.mapLabels);
                    }

                    // --- DATA PREPARATION ---
                    let data = window.APP.allData || [];
                    const locSelect = document.getElementById('map-location-filter');
                    let filterValue = window.APP.mapLocationFilter || (locSelect ? locSelect.value : null);
                    if (locSelect && window.APP.mapLocationFilter) {
                        locSelect.value = window.APP.mapLocationFilter;
                        window.APP.mapLocationFilter = null;
                        filterValue = locSelect.value;
                    }
                    if (filterValue && filterValue !== '') {
                        data = data.filter(x => x.location && x.location.trim().toLowerCase() === filterValue.trim().toLowerCase());
                    }

                    Swal.fire({ toast: true, position: 'top-end', icon: 'info', title: 'Veriler İşleniyor', text: `${data.length} veri analiz ediliyor...`, timer: 2000, showConfirmButton: false });

                    window.APP.mapMarkers.clearLayers();

                    data.forEach((item, idx) => {
                        const id = String(item.listingNo);
                        const searchContext = (item.location || '') + ' ' + (item.title || '') + ' ' + (item.description || '');
                        const searchLower = searchContext.toLocaleLowerCase('tr-TR');

                        let baseLat = CITY_CENTER.lat;
                        let baseLng = CITY_CENTER.lng;
                        let spread = 0.004; // Varsayılan Sıkı Dağılım (Küme için)
                        let matched = false;

                        // 1. KNOWN COORDINATES CHECK
                        for (const [key, coord] of Object.entries(ESK_COORDS)) {
                            if (searchLower.includes(key.toLocaleLowerCase('tr-TR'))) {
                                baseLat = coord.lat;
                                baseLng = coord.lng;
                                matched = true;
                                break;
                            }
                        }

                        // 2. VIRTUAL CLUSTERING (Sanal Mahalle)
                        // Eğer koordinat listemizde yoksa, metnin kendisine göre sanal bir koordinat üret.
                        // Böylece aynı mahalle ismine sahip tüm ilanlar haritada aynı (rastgele ama sabit) noktada toplanır.
                        if (!matched) {
                            // En anlamlı kelimeyi bulmaya çalış (Basitçe location'ı al)
                            const locationSignature = (item.location || 'Bilinmeyen').trim().toLocaleLowerCase('tr-TR');

                            // Hash üret
                            let hashLoc = 0;
                            for (let i = 0; i < locationSignature.length; i++) hashLoc = ((hashLoc << 5) - hashLoc) + locationSignature.charCodeAt(i) | 0;

                            // Hash'i Eskişehir sınırları içinde bir koordinata map'le
                            // Eskişehir ~ Lat: 39.7 - 39.85, Lng: 30.3 - 30.7
                            // Deterministik Random
                            const normHash = Math.abs(hashLoc) % 10000;
                            baseLat = 39.72 + (normHash / 10000) * 0.10; // 39.72 - 39.82 arası

                            let hashLoc2 = 0; // İkinci hash için stringi tersten tara
                            for (let i = locationSignature.length - 1; i >= 0; i--) hashLoc2 = ((hashLoc2 << 5) - hashLoc2) + locationSignature.charCodeAt(i) | 0;
                            const normHash2 = Math.abs(hashLoc2) % 10000;
                            baseLng = 30.45 + (normHash2 / 10000) * 0.15; // 30.45 - 30.60 arası

                            spread = 0.005; // Sanal kümeler de sıkı olsun
                        }

                        // 3. Jitter (Tek nokta üstüne binmesin diye ufak dağıt)
                        let str = id + "salt_v3";
                        let hash = 0; for (let i = 0; i < str.length; i++) hash = ((hash << 5) - hash) + str.charCodeAt(i) | 0;
                        const seed = Math.abs(hash);
                        const angle = (seed % 360) * (Math.PI / 180);
                        const radius = (Math.sqrt((seed % 1000) / 1000) * spread); // Spread burada devreye giriyor

                        const lat = baseLat + (radius * Math.cos(angle));
                        const lng = baseLng + ((radius * Math.sin(angle)) * 1.6);

                        // Color & Marker
                        let colorHex = '#f59e0b'; // Kiralık (Turuncu)
                        if (item.listingType === 'Satılık') colorHex = '#0ea5e9'; // Satılık (Mavi)
                        if (window.APP.crmEntries && window.APP.crmEntries[item.listingNo]) colorHex = '#10b981'; // CRM (Yeşil)

                        const marker = L.circleMarker([lat, lng], {
                            radius: 5, fillColor: colorHex, color: "#fff", weight: 1, opacity: 0.8, fillOpacity: 0.8
                        });

                        marker.bindPopup(`
                            <div class="glass-card p-0 min-w-[240px] overflow-hidden shadow-2xl border border-white/10 rounded-xl relative font-sans">
                                <div class="p-3 bg-slate-900/90 border-b border-white/5 flex items-center justify-between">
                                    <span class="px-2 py-0.5 rounded text-[9px] font-bold uppercase tracking-wider ${item.listingType === 'Satılık' ? 'bg-blue-500/20 text-blue-400' : 'bg-amber-500/20 text-amber-400'}">${item.listingType}</span>
                                    <span class="text-[10px] text-slate-500 font-mono">#${item.listingNo}</span>
                                </div>
                                <div class="p-4 bg-slate-950/80 backdrop-blur-md">
                                    <h4 class="font-bold text-sm text-white mb-1 line-clamp-2 leading-tight">${item.title}</h4>
                                    <div class="flex items-center gap-2 mt-2 mb-3 text-[10px] text-slate-400">
                                        <i class="fa-solid fa-location-dot text-brand-500"></i> <span class="truncate">${item.location || 'Sanal Konum'}</span>
                                    </div>
                                    <div class="text-lg font-bold text-white tracking-tight">${parseInt(item.price).toLocaleString()} ₺</div>
                                </div>
                                <div class="grid grid-cols-4 divide-x divide-white/5 bg-slate-900 border-t border-white/5">
                                    <button onclick="APP.actions.goHunter('${item.listingNo}')" class="py-3 text-slate-400 hover:text-white hover:bg-white/5 transition flex flex-col items-center gap-1"><i class="fa-solid fa-list text-[10px]"></i><span class="text-[8px] font-bold uppercase">LİSTE</span></button>
                                    <button onclick="APP.modals.openManual('edit', APP.allData.find(x=>String(x.listingNo)=='${item.listingNo}'))" class="py-3 text-slate-400 hover:text-white hover:bg-white/5 transition flex flex-col items-center gap-1"><i class="fa-solid fa-eye text-[10px]"></i><span class="text-[8px] font-bold uppercase">DETAY</span></button>
                                    <button onclick="APP.modals.openCrm('${item.listingNo}')" class="py-3 text-slate-400 hover:text-white hover:bg-white/5 transition flex flex-col items-center gap-1"><i class="fa-solid fa-headset text-[10px]"></i><span class="text-[8px] font-bold uppercase">CRM</span></button>
                                    <button onclick="window.open('https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}', '_blank')" class="py-3 text-slate-400 hover:text-white hover:bg-white/5 transition flex flex-col items-center gap-1"><i class="fa-solid fa-diamond-turn-right text-[10px]"></i><span class="text-[8px] font-bold uppercase">YOL</span></button>
                                </div>
                            </div>
                        `);
                        window.APP.mapMarkers.addLayer(marker);
                    });

                    setTimeout(() => {
                        if (window.APP.mapInstance) window.APP.mapInstance.invalidateSize();
                    }, 200);
                },

                cardTemplate: function (item, type) {
                    const isPortfolio = type === 'portfolio';
                    const isHunter = type === 'hunter';
                    const isCrm = type === 'crm';
                    let displayDate = item.date ? new Date(item.date).toLocaleDateString('tr-TR') : "-";
                    const hasPhone = item.phone && item.phone !== '-' && item.phone !== '';
                    const itemIdx = (window.APP.allData || []).findIndex(x => x.listingNo === item.listingNo);

                    // CRM Specific Data
                    let crmStatusHtml = '';
                    let crmNoteHtml = '';
                    let crmActionsHtml = '';

                    if (isCrm) {
                        const entry = window.APP.crmEntries[item.listingNo] || {};
                        // Status Badge
                        let statusColor = "bg-slate-500/20 text-slate-300";
                        if (entry.status === 'Teklif') statusColor = "bg-amber-500/20 text-amber-300";
                        if (entry.status === 'Satıldı') statusColor = "bg-green-500/20 text-green-300";
                        if (entry.status === 'Arandı') statusColor = "bg-blue-500/20 text-blue-300";

                        crmStatusHtml = `< span class="${statusColor} px-2 py-0.5 rounded text-[8px] font-bold uppercase tracking-wider border border-white/5 ml-2" > ${entry.status || 'Görüşülüyor'}</span > `;

                        // Note Excerpt
                        if (entry.note) {
                            crmNoteHtml = `< div class="mt-2 p-2 bg-white/5 rounded-lg border border-white/5 text-[10px] text-slate-300 italic truncate relative" title = "${entry.note}" > <i class="fa-solid fa-note-sticky text-slate-500 mr-2"></i>${entry.note}</div > `;
                        }

                        // CRM Actions
                        crmActionsHtml = `
                            < button onclick = "APP.actions.addToPortfolio('${item.listingNo}')" class="px-3 py-1.5 bg-brand-500/10 text-brand-400 hover:bg-brand-500 hover:text-white rounded-lg text-[9px] font-bold uppercase transition flex items-center gap-1" > <i class="fa-solid fa-briefcase"></i> PORTFÖY</button >
                            <button onclick="APP.modals.openCrm('${item.listingNo}', true)" class="px-3 py-1.5 bg-indigo-500/20 text-indigo-300 hover:bg-indigo-500 hover:text-white rounded-lg text-[9px] font-bold uppercase transition flex items-center gap-1"><i class="fa-solid fa-pen"></i> DÜZENLE</button>
                            <button onclick="APP.actions.deleteCrm('${item.listingNo}')" class="px-3 py-1.5 bg-red-500/10 text-red-500 hover:bg-red-500 hover:text-white rounded-lg text-[9px] font-bold uppercase transition flex items-center gap-1"><i class="fa-solid fa-trash"></i> SİL</button>
                        `;
                    }

                    return `
                            < div class="glass-card p-4 rounded-xl flex items-center gap-4 animate-fade-in shadow-lg border-white/10 group relative overflow-hidden" >
                                ${isCrm ? `<div class="absolute top-0 left-0 w-1 h-full bg-indigo-500/30"></div>` : ''}
                        <div class="w-10 h-10 bg-brand-500/10 rounded-xl flex items-center justify-center border border-brand-500/30 shrink-0 shadow-inner group-hover:bg-brand-500 group-hover:text-white transition-all font-black">A</div>
                        <div class="flex-1 grid grid-cols-12 items-center gap-4">
                            <div class="col-span-4">
                                <h4 class="text-xs font-bold uppercase tracking-tight text-white leading-tight mb-1 truncate" title="${item.title}">${item.title}</h4>
                                <div class="flex items-center">
                                    <span class="text-[9px] text-slate-500 font-bold uppercase tracking-wider">${item.location}</span>
                                    ${crmStatusHtml}
                                </div>
                                ${crmNoteHtml}
                            </div>
                            <div class="col-span-3 border-l border-white/5 pl-4"><div class="grid grid-cols-2 gap-y-1"><div class="text-[9px] text-slate-500 uppercase font-bold">Alan: <span class="text-white ml-1 font-medium text-[10px]">${item.m2 || '-'}</span></div><div class="text-[9px] text-slate-500 uppercase font-bold">Oda: <span class="text-white ml-1 font-medium text-[10px]">${item.rooms || '-'}</span></div><div class="text-[9px] text-slate-500 uppercase font-bold">Kat: <span class="text-white ml-1 font-medium text-[10px]">${item.floor || '-'}</span></div><div class="text-[9px] text-slate-500 uppercase font-bold">Tarih: <span class="text-accent-secondary ml-1 font-bold text-[10px]">${displayDate}</span></div></div></div>
                            <div class="col-span-2 flex flex-col items-center">
                                <button onclick="APP.actions.copyToClipboard('${item.listingNo}')" class="px-3 py-1 bg-black rounded-lg border border-brand-500/20 hover:border-brand-500 transition-all flex items-center gap-2 group shadow-inner mb-2">
                                    <span class="text-[10px] font-mono font-bold text-brand-400 tracking-wider">${item.listingNo}</span>
                                    <i class="fa-solid fa-copy text-[10px] text-slate-600 group-hover:text-brand-400"></i>
                                </button>
                                <div class="flex gap-2">
                                    <button onclick="APP.modals.openManual('edit', APP.allData[${itemIdx}])" class="action-icon btn-edit w-7 h-7 text-[10px]"><i class="fa-solid fa-pen"></i></button>
                                    <button onclick="APP.actions.deleteListing('${item.listingNo}')" class="action-icon btn-delete w-7 h-7 text-[10px]"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            </div>
                            <div class="col-span-3 flex items-center justify-end gap-3">
                                <div class="text-right">
                                    <p class="text-sm font-bold text-white leading-none">${parseInt(item.price || 0).toLocaleString()} ₺</p>
                                    <span class="text-[8px] font-bold text-brand-400 uppercase mt-1 inline-block opacity-80">${item.from || 'Excel'}</span>
                                    <div class="text-[10px] text-slate-400 mt-1 font-mono">${hasPhone ? item.phone : `<button onclick='APP.modals.openManual(\"edit\", APP.allData[${itemIdx}])' class="btn-phone rounded px-2 py-0.5"><i class="fa-solid fa-phone mr-1"></i>Ekle</button>`}</div>
                                </div>
                                ${isHunter ? `<button onclick="APP.modals.openCrm('${item.listingNo}')" class="px-4 py-2 bg-brand-500 text-white rounded-lg text-[9px] font-bold uppercase hover:bg-brand-600 transition shadow-lg shrink-0">CRM</button>` : ''}
                                ${isPortfolio ? `<button onclick="APP.actions.markAsSuccess('${item.listingNo}')" class="px-4 py-2 bg-accent-success text-white rounded-lg text-[9px] font-bold uppercase hover:bg-green-700 transition shadow-lg shrink-0">BİTİR</button>` : ''}
                                ${crmActionsHtml}
                            </div>
                        </div>
                    </div > `;
                },

                reminders: async function () {
                    if (!window.pywebview?.api?.get_reminders) return;
                    const container = document.getElementById('reminders-list');
                    if (!container) return;

                    const reminders = await window.pywebview.api.get_reminders();
                    if (!reminders || reminders.length === 0) {
                        container.innerHTML = '<div class="text-center py-10 opacity-30 uppercase font-bold text-sm tracking-widest text-white">Planlanmış Hatırlatma Yok</div>';
                        return;
                    }

                    container.innerHTML = reminders.map(r => `
                            < div class="glass-card p-4 rounded-xl flex items-center gap-4 shadow-lg border-l-4 ${r.type === 'Kira' ? 'border-indigo-500' : 'border-brand-500'}" >
                            <div class="w-12 h-12 bg-white/5 rounded-lg flex flex-col items-center justify-center">
                                <span class="text-[10px] font-bold text-slate-400 uppercase">${r.type}</span>
                                <i class="fa-solid fa-${r.type === 'Kira' ? 'key' : 'file-contract'} text-lg text-white"></i>
                            </div>
                            <div class="flex-1">
                                <h4 class="font-bold text-white text-sm">${r.title}</h4>
                                <div class="flex gap-4 text-[10px] text-slate-400 mt-1">
                                    <span><i class="fa-solid fa-calendar mr-1"></i> ${r.date}</span>
                                    <span><i class="fa-solid fa-money-bill mr-1"></i> ${parseInt(r.amount).toLocaleString()} ₺</span>
                                </div>
                                <div class="text-[10px] italic text-slate-500 mt-1 truncate max-w-[300px] text-white">${r.text || ''}</div>
                            </div>
                            <button onclick="APP.actions.deleteReminder('${r.id}')" class="w-8 h-8 rounded-full bg-red-500/10 text-red-500 hover:bg-red-500 hover:text-white transition flex items-center justify-center"><i class="fa-solid fa-check"></i></button>
                        </div >
                            `).join('');
                },

                chart: function () {
                    const ctx = document.getElementById('main-chart');
                    if (!ctx) return;

                    // SAFE DESTROY (Double Check)
                    if (window.alphaChart) { window.alphaChart.destroy(); window.alphaChart = null; }
                    if (window.APP.charts && window.APP.charts.main) { window.APP.charts.main.destroy(); window.APP.charts.main = null; }
                    /* Check for any cached chart instance on canvas element itself */
                    const chartStatus = Chart.getChart("main-chart");
                    if (chartStatus != undefined) { chartStatus.destroy(); }

                    const data = window.APP.allData || [];
                    const counts = [
                        data.filter(x => x.listingType === 'Satılık').length,
                        data.filter(x => x.listingType === 'Kiralık').length
                    ];

                    window.alphaChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Satılık', 'Kiralık'],
                            datasets: [{ data: counts, backgroundColor: ['#3b82f6', '#f59e0b'], borderWidth: 0 }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'bottom', labels: { color: '#ffffff', font: { size: 10, weight: 'bold' } } }
                            },
                            cutout: '75%'
                        }
                    });

                    // Sync reference
                    if (!window.APP.charts) window.APP.charts = {};
                    window.APP.charts.main = window.alphaChart;
                },

            },


            actions: {
                // Helper for Map
                goHunter: function (lNo) {
                    // 1. Filter
                    window.APP.hunterListingNoFilter = lNo; // Set the filter
                    window.APP.nav('hunter'); // Navigate to hunter view, which will re-render with filter
                    // 2. Open Edit (Optional, or just highlight)
                    // Let's just create a toast
                    Swal.fire({ toast: true, icon: 'success', title: 'İlan Seçildi', position: 'top-end', timer: 1000 });
                },

                openDetails: function (lNo) {
                    const item = (window.APP.allData || []).find(x => String(x.listingNo) === String(lNo));
                    if (item) window.APP.modals.openManual('edit', item);
                },

                copyToClipboard: function (text) { const el = document.createElement('textarea'); el.value = text; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el); Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'Kopyalandı', showConfirmButton: false, timer: 1500, background: '#0f172a', color: '#fff' }); },
                syncExcel: async function () {
                    Swal.fire({
                        title: 'Veriler Yükleniyor',
                        text: 'Yerel veritabanı güncelleniyor, lütfen bekleyin...',
                        icon: 'info',
                        background: '#0f172a',
                        color: '#fff',
                        showConfirmButton: false,
                        allowOutsideClick: false
                    });
                    Swal.showLoading();

                    try {
                        if (window.pywebview?.api?.manual_sync) {
                            const res = await window.pywebview.api.manual_sync();
                            if (res.success) {
                                Swal.fire({ icon: 'success', title: 'Tamamlandı', text: 'Tüm veriler güncellendi.', timer: 1500, showConfirmButton: false, background: '#0f172a', color: '#fff' });
                            } else {
                                Swal.fire({ icon: 'error', title: 'Hata', text: res.msg, background: '#0f172a', color: '#fff' });
                            }
                        } else {
                            // Fallback
                            if (window.pywebview?.api?.start_sync) window.pywebview.api.start_sync();
                            setTimeout(() => Swal.close(), 2000);
                        }
                    } catch (e) {
                        Swal.fire({ icon: 'error', title: 'Bağlantı Hatası', text: String(e), background: '#0f172a', color: '#fff' });
                    }
                },

                // --- FILE UPLOAD LOGIC ---
                triggerFileSelect: async function () {
                    if (!window.pywebview?.api?.select_file) return;
                    const filePath = await window.pywebview.api.select_file();
                    if (filePath) {
                        // 1. Start Analysis UI
                        document.getElementById('arc-file-label').innerText = "Analiz Ediliyor... Lütfen bekleyin.";
                        document.getElementById('arc-file-label').style.opacity = '1';
                        document.getElementById('arc-file-label').classList.add('animate-pulse');

                        // 2. Call API
                        const analysis = await window.pywebview.api.analyze_document(filePath);

                        // 3. Fill Form
                        document.getElementById('arc-file-label').innerText = filePath.split('\\').pop();
                        document.getElementById('arc-file-label').classList.remove('animate-pulse');

                        document.getElementById('arc-path').value = filePath; // Hidden input
                        document.getElementById('arc-date').value = analysis.date || new Date().toISOString().split('T')[0];
                        document.getElementById('arc-amount').value = analysis.amount || '';
                        document.getElementById('arc-type').value = analysis.type || 'Diğer';

                        // Smart Name Guess
                        if (!document.getElementById('arc-name').value) {
                            document.getElementById('arc-name').value = "Yeni Kayıt";
                        }

                        Swal.fire({ toast: true, icon: 'success', title: 'Analiz Tamamlandı', text: 'Veriler forma dolduruldu, lütfen kontrol edip onaylayın.' });
                    }
                },

                saveArchive: async function () {
                    const fPath = document.getElementById('arc-path').value;
                    const fType = document.getElementById('arc-type').value;
                    const fDate = document.getElementById('arc-date').value;
                    const fName = document.getElementById('arc-name').value;
                    const fAmount = document.getElementById('arc-amount').value;

                    if (!fPath) { Swal.fire({ toast: true, icon: 'error', title: 'Dosya seçilmedi' }); return; }
                    if (!fName) { Swal.fire({ toast: true, icon: 'warning', title: 'Bir isim giriniz' }); return; }

                    // SAVE REMINDER
                    const reminderData = {
                        title: fName,
                        date: fDate,
                        type: fType,
                        amount: fAmount || 0,
                        file: fPath
                    };
                    await window.pywebview.api.save_reminder(reminderData);

                    // COPY FILE (Classic Archive)
                    await window.pywebview.api.upload_document(fPath, fType, fDate, fName);

                    document.getElementById('modal-archive').classList.add('hidden');
                    Swal.fire({
                        title: 'Kaydedildi',
                        text: 'Dosya arşivlendi ve hatırlatıcı kuruldu.',
                        icon: 'success',
                        background: '#0f172a',
                        color: '#fff'
                    });

                    APP.render.reminders();
                },

                deleteReminder: async function (id) {
                    await window.pywebview.api.delete_reminder(id);
                    APP.render.reminders();
                    Swal.fire({ toast: true, icon: 'success', title: 'Tamamlandı/Silindi' });
                },

                saveCrm: async function () {
                    const no = String(window.APP.activeListingNo); // Force String
                    if (!no || no === 'undefined') return;

                    const note = document.getElementById('crm-note').value;
                    const date = document.getElementById('crm-date').value;
                    const status = document.getElementById('crm-status').value;
                    const phone = document.getElementById('crm-phone').value;

                    if (!note) { Swal.fire({ toast: true, icon: 'warning', title: 'Not giriniz' }); return; }

                    // 1. Update List Data (Phone persistence)
                    const listIdx = window.APP.allData.findIndex(d => String(d.listingNo) === no);
                    if (listIdx >= 0) {
                        window.APP.allData[listIdx].phone = phone;
                        window.pywebview.api.save_data('alpha_database', JSON.stringify(window.APP.allData));
                    }

                    // 2. Update CRM Data
                    const currentEntry = window.APP.crmEntries[no] || { history: [] };
                    // Migrate old string notes
                    if (currentEntry.note && !currentEntry.history) {
                        currentEntry.history = [{ date: currentEntry.date, note: currentEntry.note, status: 'Eski' }];
                        delete currentEntry.note;
                    }
                    if (!currentEntry.history) currentEntry.history = [];

                    currentEntry.history.unshift({
                        date: new Date().toLocaleString(),
                        note: note,
                        status: status,
                        appointment: date
                    });

                    currentEntry.status = status;
                    currentEntry.date = date;
                    currentEntry.note = note;
                    currentEntry.phone = phone;

                    window.APP.crmEntries[no] = currentEntry;
                    const saved = await window.pywebview.api.save_data('crm_db', JSON.stringify(window.APP.crmEntries));

                    // 3. AZI SUNUCUSUNA AKTAR (Eğer Satıldıysa)
                    if (status === 'Satıldı') {
                        const itm = (window.APP.allData || []).find(d => String(d.listingNo) === no);
                        if (itm && window.pywebview?.api?.sync_sale_to_azi) {
                            try {
                                await window.pywebview.api.sync_sale_to_azi(no, itm.price, note);
                                Swal.fire({ toast: true, icon: 'info', title: 'Azi Sunucusuna Bildirildi', timer: 2000 });
                            } catch (e) { console.error("Sync Error", e); }
                        }
                    }

                    // 4. UI UPDATE & NAVIGATE
                    document.getElementById('modal-crm').classList.add('hidden');
                    Swal.fire({ toast: true, icon: 'success', title: 'Görüşme Kaydedildi' });

                    // Force refresh and nav
                    window.APP.render.all();
                    setTimeout(() => window.APP.nav('crm'), 100); // Slight delay to ensure render
                },
                deleteCrm: async function (no) {
                    const res = await Swal.fire({ title: 'Silinsin mi?', text: "Görüşme kaydı silinecek.", icon: 'warning', showCancelButton: true, confirmButtonColor: '#ef4444', confirmButtonText: 'Evet, Sil', background: '#0f172a', color: '#fff' });
                    if (res.isConfirmed) {
                        delete window.APP.crmEntries[no];
                        if (window.pywebview?.api?.save_data) await window.pywebview.api.save_data('crm_db', JSON.stringify(window.APP.crmEntries));
                        window.APP.render.all();
                    }
                },
                deleteRandevu: async function (no) {
                    if (window.APP.crmEntries[no]) {
                        window.APP.crmEntries[no].date = '';
                        if (window.pywebview?.api?.save_data) await window.pywebview.api.save_data('crm_db', JSON.stringify(window.APP.crmEntries));
                        window.APP.render.all();
                        Swal.fire({ toast: true, position: 'top-end', icon: 'info', title: 'Randevu İptal Edildi', background: '#0f172a', color: '#fff', timer: 1500, showConfirmButton: false });
                    }
                },
                deleteListing: async function (no) {
                    const res = await Swal.fire({ title: 'İlan Silinsin mi?', text: "Bu işlem geri alınamaz.", icon: 'warning', showCancelButton: true, confirmButtonColor: '#ef4444', background: '#0f172a', color: '#fff' });
                    if (res.isConfirmed) {
                        window.APP.allData = window.APP.allData.filter(x => String(x.listingNo) !== String(no));
                        window.APP.portfolioData = window.APP.portfolioData.filter(x => String(x.listingNo) !== String(no));
                        if (window.pywebview?.api?.save_data) {
                            await window.pywebview.api.save_data('alpha_database', JSON.stringify(window.APP.allData));
                            await window.pywebview.api.save_data('portfolio_db', JSON.stringify(window.APP.portfolioData));
                        }
                        window.APP.render.all();
                    }
                },
                addToPortfolio: async function (no) {
                    const itm = (window.APP.allData || []).find(d => String(d.listingNo) === String(no));
                    if (!itm) return;
                    if (!window.APP.portfolioData.find(p => String(p.listingNo) === String(no))) {
                        window.APP.portfolioData.push(itm);
                        if (window.pywebview?.api?.save_data) {
                            const saved = await window.pywebview.api.save_data('portfolio_db', JSON.stringify(window.APP.portfolioData));
                            if (!saved) {
                                Swal.fire({ title: 'Hata', text: 'Portföye kaydedilemedi!', icon: 'error' });
                                return;
                            }
                        }
                    }
                    window.APP.render.all();
                    Swal.fire({ toast: true, position: 'top-end', icon: 'success', title: 'Portföye Taşındı', background: '#0f172a', color: '#fff', timer: 1500, showConfirmButton: false });
                },
                markAsSuccess: async function (no) {
                    const itm = (window.APP.portfolioData || []).find(d => String(d.listingNo) === String(no));
                    if (!itm) return;
                    window.APP.successData.push({ ...itm, completedDate: new Date().toISOString() });
                    window.APP.portfolioData = window.APP.portfolioData.filter(x => String(x.listingNo) !== String(no));
                    if (window.pywebview?.api?.save_data) {
                        await window.pywebview.api.save_data('portfolio_db', JSON.stringify(window.APP.portfolioData));
                        await window.pywebview.api.save_data('success_db', JSON.stringify(window.APP.successData));
                    }
                    window.APP.render.all();
                    Swal.fire({ icon: 'success', title: 'Tebrikler!', background: '#0f172a', color: '#fff' });
                },
                saveManual: async function () {
                    const data = {
                        title: document.getElementById('m-title').value,
                        listingNo: document.getElementById('m-no').value,
                        price: parseInt(document.getElementById('m-price').value || 0),
                        location: document.getElementById('m-loc').value,
                        m2: document.getElementById('m-m2').value,
                        rooms: document.getElementById('m-rooms').value,
                        floor: document.getElementById('m-floor').value,
                        type: document.getElementById('m-type').value,
                        from: document.getElementById('m-from').value,
                        phone: document.getElementById('m-phone').value,
                        date: document.getElementById('m-date').value || new Date().toISOString(),
                        status: 'Aktif'
                    };
                    if (!data.title || !data.listingNo) return;

                    // 1. Ana veritabanını güncelle
                    const idx = window.APP.allData.findIndex(x => String(x.listingNo) === String(data.listingNo));
                    if (idx > -1) window.APP.allData[idx] = data; else window.APP.allData.unshift(data);

                    // 2. Portföy veritabanını güncelle (Eğer ilan portföydeyse)
                    const pIdx = window.APP.portfolioData.findIndex(x => String(x.listingNo) === String(data.listingNo));
                    if (pIdx > -1) window.APP.portfolioData[pIdx] = data;

                    // 3. Her iki dosyayı da diske kaydet
                    if (window.pywebview?.api?.save_data) {
                        await window.pywebview.api.save_data('alpha_database', JSON.stringify(window.APP.allData));
                        await window.pywebview.api.save_data('portfolio_db', JSON.stringify(window.APP.portfolioData));
                    }

                    document.getElementById('modal-manual').classList.add('hidden');
                    window.APP.render.all();
                }
            },

            // Analiz Fonksiyonları
            ai: {
                runEngine: async function (type) {
                    Swal.fire({ title: 'AI İşleniyor', text: 'Veriler analiz ediliyor...', icon: 'info', showConfirmButton: false, background: '#0f172a', color: '#fff' });

                    try {
                        let result = await window.pywebview.api.run_ai_analysis(type);

                        if (result) {
                            if (result.data && result.data.length > 0) {
                                // Actionable Result
                                Swal.fire({
                                    title: result.title,
                                    text: result.text,
                                    icon: result.icon,
                                    background: '#0f172a',
                                    color: '#fff',
                                    showCancelButton: true,
                                    confirmButtonText: 'İlanları Göster',
                                    cancelButtonText: 'Tamam'
                                }).then((res) => {
                                    if (res.isConfirmed) {
                                        // Filter Main List
                                        const ids = new Set(result.data.map(x => x.listingNo));
                                        window.APP.allData = window.APP.allData.filter(x => ids.has(x.listingNo));
                                        window.APP.nav('hunter');
                                        Swal.fire({ toast: true, icon: 'success', title: 'Liste Filtrelendi', background: '#0f172a', color: '#fff' });
                                    }
                                });
                            } else {
                                // Standard Result
                                Swal.fire({
                                    title: result.title,
                                    text: result.text,
                                    icon: result.icon || 'info',
                                    background: '#0f172a',
                                    color: '#fff'
                                });
                            }
                        }
                    } catch (e) {
                        console.error(e);
                        Swal.fire({ title: 'Hata', text: 'Analiz motoru cevap vermedi.', icon: 'error', background: '#0f172a', color: '#fff' });
                    }
                }
            },

            // --- ARCHIVE LOGIC ---
            archiveData: [],
            loadArchives: async function () {
                try {
                    const raw = await window.pywebview.api.load_data('archives_db');
                    this.archiveData = JSON.parse(raw || '[]');

                    const grid = document.getElementById('archive-list');
                    if (grid) {
                        grid.innerHTML = this.archiveData.map(file => `
                            < div class="glass-card p-4 rounded-xl relative group border border-white/5 hover:border-brand-500/30 transition-all" >
                                <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition z-10">
                                    <button onclick="APP.actions.openArchive('${file.filename}', '${file.folderPath}')" class="w-7 h-7 bg-brand-500 rounded text-white text-[10px] shadow-lg hover:bg-brand-400 transition"><i class="fa-solid fa-eye"></i></button>
                                </div>
                                <div class="text-center mb-3 pt-2">
                                    <div class="w-12 h-12 mx-auto bg-slate-800 rounded-lg flex items-center justify-center text-brand-400 text-2xl mb-2">
                                        <i class="fa-solid fa-file-contract"></i>
                                    </div>
                                    <span class="px-2 py-0.5 bg-white/5 rounded text-[8px] text-slate-400 uppercase tracking-widest">${file.type || 'Genel'}</span>
                                </div>
                                <h4 class="text-[10px] font-bold text-white truncate text-center mb-1" title="${file.name}">${file.name || 'İsimsiz'}</h4>
                                <p class="text-[9px] text-slate-500 text-center truncate font-mono">${file.date || '-'}</p>
                                
                                <div class="mt-3 pt-2 border-t border-white/5 text-[8px] text-slate-600 truncate flex items-center justify-center gap-1">
                                    <i class="fa-solid fa-folder-open"></i> ${file.folderDisplay || 'Arşiv'}
                                </div>
                            </div >
                        `).join('') || '<div class="col-span-full flex flex-col items-center justify-center py-12 opacity-30"><i class="fa-solid fa-folder-open text-4xl mb-2"></i><span class="text-xs uppercase font-bold tracking-widest">Arşiv Boş</span></div>';
                    }
                } catch (e) { console.error("Archive Load Error:", e); }
            }
        };

        // Modal & Actions Injection
        window.APP.modals.openArchiveUpload = function () {
            document.getElementById('modal-archive').classList.remove('hidden');
            window.APP.loadArchives(); // refresh
        };

        window.APP.actions.triggerFileSelect = function () {
            window.pywebview.api.select_file().then(res => {
                if (res) {
                    document.getElementById('arc-file-label').innerText = res;
                    window.APP.selectedFilePath = res;
                }
            });
        };

        window.APP.actions.copyId = function (id) {
            const el = document.createElement('textarea');
            el.value = id;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            Swal.fire({ toast: true, position: 'top-end', showConfirmButton: false, timer: 1500, icon: 'success', title: 'Kopyalandı: ' + id, background: '#0f172a', color: '#fff' });
        };

        window.APP.actions.saveCrm = async function () {
            const no = window.APP.activeListingNo;
            if (!no) return;
            const note = document.getElementById('crm-note').value;
            const date = document.getElementById('crm-date').value;
            const status = document.getElementById('crm-status').value;
            const phone = document.getElementById('crm-phone').value; // New

            if (!note) { Swal.fire({ toast: true, icon: 'warning', title: 'Not giriniz' }); return; }

            // 1. Update List Data (Phone persistence)
            const listIdx = window.APP.allData.findIndex(d => String(d.listingNo) === String(no));
            if (listIdx >= 0) {
                window.APP.allData[listIdx].phone = phone;
                window.pywebview.api.save_data('alpha_database', JSON.stringify(window.APP.allData));
            }

            // 2. Update CRM Data
            const currentEntry = window.APP.crmEntries[no] || { history: [] };
            // Migrate old string notes
            if (currentEntry.note && !currentEntry.history) {
                currentEntry.history = [{ date: currentEntry.date, note: currentEntry.note, status: 'Eski' }];
                delete currentEntry.note;
            }
            if (!currentEntry.history) currentEntry.history = [];

            currentEntry.history.unshift({
                date: new Date().toLocaleString(),
                note: note,
                status: status,
                appointment: date
            });

            currentEntry.status = status;
            currentEntry.date = date;
            currentEntry.note = note;
            currentEntry.phone = phone; // Persist in CRM too

            window.APP.crmEntries[no] = currentEntry;
            const saved = await window.pywebview.api.save_data('crm_db', JSON.stringify(window.APP.crmEntries));

            // 3. AZI SUNUCUSUNA AKTAR (Eğer Satıldıysa)
            if (status === 'Satıldı') {
                const itm = (window.APP.allData || []).find(d => String(d.listingNo) === String(no));
                if (itm && window.pywebview?.api?.sync_sale_to_azi) {
                    try {
                        await window.pywebview.api.sync_sale_to_azi(no, itm.price, note);
                        Swal.fire({ toast: true, icon: 'info', title: 'Azi Sunucusuna Bildirildi', timer: 2000 });
                    } catch (e) { console.error("Sync Error", e); }
                }
            }

            if (saved) {
                document.getElementById('modal-crm').classList.add('hidden');
                Swal.fire({ toast: true, icon: 'success', title: 'Görüşme Kaydedildi' });
                window.APP.render.all();

                // 4. CRM Sayfasına Yönlendir
                window.APP.nav('crm');
            } else {
                Swal.fire({ title: 'Kayıt Hatası', text: 'Veri diske yazılamadı!', icon: 'error' });
            }
        };

        window.APP.actions.saveArchive = async function () {
            // Yeni Alanlar
            const arcType = document.getElementById('arc-type').value; // Satış, Kiralık vb.
            const arcDate = document.getElementById('arc-date').value;
            const arcName = document.getElementById('arc-name').value;
            const path = window.APP.selectedFilePath;

            if (!path) { Swal.fire({ toast: true, icon: 'warning', title: 'Lütfen dosya seçiniz' }); return; }
            if (!arcName) { Swal.fire({ toast: true, icon: 'warning', title: 'Lütfen dosya/müşteri adı giriniz' }); return; }

            // Eğer tarih seçilmediyse bugünü ver
            const finalDate = arcDate || new Date().toISOString().split('T')[0];

            Swal.fire({
                title: 'Arşivleniyor...',
                html: 'Dosya klasörleniyor:<br>Arşiv / ' + arcType + ' / ' + finalDate + ' / ' + arcName,
                timerProgressBar: true,
                didOpen: () => { Swal.showLoading() },
                background: '#0f172a', color: '#fff'
            });

            // Backend'e Yapılandırılmış Veri Gönder
            const success = await window.pywebview.api.upload_document(path, arcType, finalDate, arcName);

            if (success) {
                Swal.fire({ toast: true, icon: 'success', title: 'Dosya Arşivlendi ve Klasörlendi' });
                document.getElementById('modal-archive').classList.add('hidden');

                // Reset Fields
                document.getElementById('arc-name').value = '';
                document.getElementById('arc-file-label').innerText = 'Dosya seçilmedi';
                document.getElementById('arc-file-label').classList.remove('opacity-100');
                document.getElementById('arc-file-label').classList.add('opacity-0');
                window.APP.selectedFilePath = null;

                window.APP.loadArchives();
            } else {
                Swal.fire({ toast: true, icon: 'error', title: 'Hata oluştu' });
            }
        };

        window.APP.actions.filterListing = function (listingNo) {
            const found = (window.APP.allData || []).filter(x => String(x.listingNo) === String(listingNo));
            if (found.length > 0) {
                window.APP.allData = found;
                window.APP.nav('hunter');
                Swal.fire({ toast: true, icon: 'success', title: 'İlan Filtrelendi', background: '#0f172a', color: '#fff' });
            } else {
                Swal.fire({ toast: true, icon: 'error', title: 'İlan Bulunamadı', background: '#0f172a', color: '#fff' });
            }
        };

        window.APP.actions.startBot = async function () {
            const statusEl = document.getElementById('bot-status');
            statusEl.classList.remove('hidden');

            Swal.fire({
                title: 'Bot Başlatılıyor',
                text: 'Veri toplama işlemi biraz sürebilir...',
                icon: 'info',
                showConfirmButton: false,
                timer: 2000,
                background: '#0f172a',
                color: '#fff'
            });

            try {
                const res = await window.pywebview.api.run_scraper_bot();
                statusEl.classList.add('hidden');
                if (res.success) {
                    Swal.fire({ title: 'Başarılı', text: res.msg, icon: 'success', background: '#0f172a', color: '#fff' });
                } else {
                    Swal.fire({ title: 'Hata', text: res.msg, icon: 'error', background: '#0f172a', color: '#fff' });
                }
            } catch (e) {
                statusEl.classList.add('hidden');
                Swal.fire({ title: 'Hata', text: 'Bot başlatılamadı.', icon: 'error', background: '#0f172a', color: '#fff' });
            }
        };

        // OPEN ARCHIVE (Correct placement)
        window.APP.actions.openArchive = function (fname, folderPath) {
            window.pywebview.api.open_document(fname, folderPath);
        };

        // Window Load
        window.onload = () => APP.init();
    </script>
</body>

</html>
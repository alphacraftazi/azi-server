<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AZI | SYSTEM CORE</title>
    <link rel="stylesheet" href="blackbox.css">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Share+Tech+Mono&display=swap"
        rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Leaflet Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        /* City CRM Specific Styles */
        #city-map {
            height: 100%;
            width: 100%;
            min-height: 600px;
            border-radius: 8px;
            z-index: 1;
        }

        .city-grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            height: calc(100vh - 140px);
        }

        .calendar-day {
            padding: 10px;
            border: 1px solid #334155;
            text-align: center;
            cursor: pointer;
            transition: 0.3s;
        }

        .calendar-day:hover {
            background: #3b82f6;
            color: white;
        }

        .activity-feed {
            max-height: 400px;
            overflow-y: auto;
        }

        .feed-item {
            padding: 10px;
            border-bottom: 1px solid #334155;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .feed-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #1e293b;
            color: #00f2ff;
        }
    </style>
</head>

<body class="cyber-theme">
    <div class="background-grid"></div>
    <div class="overlay-scanline"></div>

    <nav class="side-panel">
        <div class="brand-box">
            <h1 class="glitch" data-text="AZI">AZI</h1>
            <span class="version">CORE v2.0</span>
        </div>
        <ul class="menu-list">
            <li onclick="switchView('overview')" class="active"><i class="fa-solid fa-chart-line"></i> GENEL BAKIŞ</li>
            <li onclick="switchView('agenda')"><i class="fa-regular fa-calendar-check"></i> AJANDA & NOTLAR</li>
            <li onclick="switchView('vision')"><i class="fa-solid fa-eye"></i> GÖZ (VISION)</li>
            <li onclick="switchView('city_crm')"><i class="fa-solid fa-map-location-dot"></i> ŞEHİR CRM</li>
            <li onclick="switchView('leads')"><i class="fa-solid fa-crosshairs"></i> MÜŞTERİ AVCISI</li>
            <li onclick="switchView('requests')"><i class="fa-solid fa-inbox"></i> SİTE TALEPLERİ</li>
            <li onclick="switchView('active_cards')"><i class="fa-solid fa-table-cells-large"></i> İŞLETMELER</li>
            <li onclick="switchView('licenses')"><i class="fa-solid fa-network-wired"></i> AĞ YÖNETİMİ</li>
            <li onclick="switchView('products')"><i class="fa-solid fa-box-open"></i> ÜRÜNLER</li>
            <li onclick="switchView('factory')"><i class="fa-solid fa-industry"></i> SİSTEM İNŞA</li>

        </ul>
        <div class="status-box">
            <div class="led on"></div>
            <span>SYSTEM ONLINE</span>
        </div>
    </nav>

    <main class="main-interface">

        <!-- HEADER -->
        <header class="top-hud">
            <div class="hud-title" id="pageTitle">GENEL BAKIŞ</div>
            <div class="flex items-center gap-4">
                <!-- YENİ KURULUM -->
                <button onclick="switchView('factory')" class="cyber-btn sm" title="YENİ KURULUM"
                    style="background-color:#4ade80; color:#000; border-color:#4ade80; font-weight:bold;">
                    <i class="fa-solid fa-plus"></i> KURULUM
                </button>

                <!-- AI SOHBET -->
                <button onclick="toggleChat()" class="cyber-btn sm" title="AI SOHBET"
                    style="background-color:#60a5fa; color:#000; border-color:#60a5fa; font-weight:bold;">
                    <i class="fa-solid fa-microchip"></i> AI SOHBET
                </button>

                <!-- KAMERA AÇ -->
                <button onclick="switchView('vision')" class="cyber-btn sm" title="KAMERA AÇ"
                    style="background-color:#f87171; color:#000; border-color:#f87171; font-weight:bold;">
                    <i class="fa-regular fa-eye"></i> KAMERA
                </button>

                <!-- WEB SİTESİ -->
                <button onclick="window.open('https://alphacraftazi.com', '_blank')" class="cyber-btn sm"
                    title="SİTEYE GİT"
                    style="background-color:#00f2ff; color:#000; border-color:#00f2ff; font-weight:bold;">
                    <i class="fa-solid fa-globe"></i> WEB SİTESİ
                </button>
                <div class="hud-time" id="clock">00:00:00</div>
            </div>
        </header>

        <!-- VIEW: AGENDA -->
        <section id="view-agenda" class="view-panel" style="display:none;">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 h-[calc(100vh-140px)]">
                <!-- Left: Calendar -->
                <div class="cyber-box md:col-span-2 flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="box-title text-neon-blue"><i class="fa-solid fa-calendar-days"></i> TAKVİM</h3>
                        <div class="flex gap-2">
                            <button class="cyber-btn sm" onclick="Agenda.prevMonth()">
                                << /button>
                                    <span id="agenda-month-year" class="font-mono text-xl font-bold text-white">OCAK
                                        2026</span>
                                    <button class="cyber-btn sm" onclick="Agenda.nextMonth()">></button>
                        </div>
                    </div>

                    <div class="grid grid-cols-7 gap-1 text-center font-bold text-gray-500 mb-2">
                        <div>Pzt</div>
                        <div>Sal</div>
                        <div>Çar</div>
                        <div>Per</div>
                        <div>Cum</div>
                        <div>Cmt</div>
                        <div>Paz</div>
                    </div>
                    <div id="agenda-calendar-grid" class="grid grid-cols-7 gap-1 flex-1">
                        <!-- JS Fill -->
                    </div>
                </div>

                <!-- Right: Notes & Tasks -->
                <div class="cyber-box flex flex-col">
                    <h3 class="box-title text-yellow-400"><i class="fa-solid fa-note-sticky"></i> GÜNLÜK NOTLAR</h3>
                    <div id="selected-date-display" class="text-xs text-gray-500 mb-2">Bugün</div>

                    <textarea id="agenda-note-input" class="input-cyber w-full flex-1 mb-4 resize-none p-4"
                        placeholder="Buraya not alın..."></textarea>

                    <button class="cyber-btn w-full" onclick="Agenda.saveNote()">
                        <i class="fa-solid fa-floppy-disk"></i> KAYDET
                    </button>

                    <div class="mt-4 border-t border-gray-800 pt-4">
                        <h4 class="text-xs text-gray-400 mb-2">HIZLI GÖREVLER</h4>
                        <div id="agenda-todo-list" class="space-y-2 max-h-[200px] overflow-y-auto custom-scrollbar">
                            <!-- JS Fill -->
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- VIEW: OVERVIEW (COMMAND CENTER) -->
        <section id="view-overview" class="view-panel">
            <div class="command-grid">
                <!-- BOX 1: REVENUE -->
                <div class="cyber-box revenue-box">
                    <h3 class="box-title"><i class="fa-solid fa-coins"></i> TOPLAM CİRO</h3>
                    <div class="big-number" id="dash-total-revenue">₺0,00</div>
                    <canvas id="sparklineRevenue" height="50"></canvas>
                </div>

                <!-- BOX 1b: WEBSITE STATUS (NEW) -->
                <div class="cyber-box flex flex-col justify-between">
                    <h3 class="box-title text-cyan-400"><i class="fa-solid fa-globe"></i> WEB DURUMU</h3>
                    <div class="flex items-center gap-4">
                        <div class="relative">
                            <i class="fa-solid fa-server text-3xl text-gray-600" id="web-status-icon"></i>
                            <div class="absolute -right-1 -bottom-1 w-3 h-3 bg-gray-500 rounded-full border border-black"
                                id="web-status-dot"></div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-400">alphacraftazi.com</div>
                            <div class="text-xl font-bold text-white tracking-widest" id="web-status-text">KONTROL...
                            </div>
                        </div>
                    </div>
                    <div class="text-[10px] text-gray-500 text-right mt-2 font-mono" id="web-ping-time">PING: --ms</div>
                </div>

                <!-- BOX 2: ACTIVE NODES -->
                <div class="cyber-box nodes-box">
                    <h3 class="box-title"><i class="fa-solid fa-server"></i> AKTİF NODE</h3>
                    <div class="flex-center">
                        <div class="circle-chart">
                            <svg viewBox="0 0 36 36" class="circular-chart blue">
                                <path class="circle-bg"
                                    d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                                <path class="circle" stroke-dasharray="60, 100"
                                    d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                            </svg>
                            <div class="percentage" id="statActiveNodes">0/0</div>
                        </div>
                    </div>
                </div>

                <!-- BOX 3: SYSTEM LOG -->
                <!-- BOX 3: SYSTEM LOG & CITY CRM -->
                <!-- BOX 3: SYSTEM LOG -->
                <div class="cyber-box log-box">
                    <h3 class="box-title"><i class="fa-solid fa-terminal"></i> SİSTEM GÜNLÜĞÜ</h3>
                    <div class="terminal-log" id="dashboard-log">
                        > AZI CORE INITIALIZED...<br>
                        > SCANNING NETWORK NODES...<br>
                        > WAITING FOR TELEMETRY...
                    </div>
                </div>

                <!-- BOX 4: MAP (Restored) -->
                <div class="cyber-box map-box">
                    <h3 class="box-title"><i class="fa-solid fa-globe"></i> GLOBAL DAĞILIM</h3>
                    <div class="map-placeholder">
                        <div class="radar-scan"></div>
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/ec/World_map_blank_without_borders.svg/2000px-World_map_blank_without_borders.svg.png"
                            style="opacity:0.2; width:100%;">
                    </div>
                </div>

                <!-- BOX 5: REQUESTS SHORTCUT (DYNAMIC) -->
                <div class="cyber-box p-3 cursor-pointer hover:border-green-400 transition flex flex-col justify-between hidden"
                    onclick="switchView('requests')" id="widget-new-requests">
                    <div class="flex justify-between items-center">
                        <h3 class="box-title mb-0 text-green-500"><i class="fa-solid fa-inbox"></i> YENİ TALEPLER</h3>
                        <span class="text-xs text-green-500 animate-pulse">● <span id="widget-req-count">0</span>
                            ADET</span>
                    </div>
                    <div class="text-xs text-gray-400 mt-2">
                        Web sitesinden gelen yeni formlar var!
                    </div>
                </div>

                <!-- BOX 6: LEAD HUNTER SHORTCUT (OLD) -->
                <div class="cyber-box p-3 cursor-pointer hover:border-red-400 transition flex flex-col justify-between"
                    onclick="switchView('leads')">
                    <div class="flex justify-between items-center">
                        <h3 class="box-title mb-0 text-red-500"><i class="fa-solid fa-crosshairs"></i> MÜŞTERİ AVCISI
                        </h3>
                        <span class="text-xs text-red-500 animate-pulse">● AKTİF</span>
                    </div>
                    <div class="text-xs text-gray-400 mt-2">
                        Yeni potansiyel müşterileri taramak için tıklayın.
                    </div>
                </div>

                <!-- BOX 6: CITY CRM MINI WIDGET -->
                <div class="cyber-box p-3 cursor-pointer hover:border-blue-400 transition"
                    onclick="switchView('city_crm')">
                    <div class="flex justify-between items-center">
                        <h3 class="box-title mb-0 text-neon-blue"><i class="fa-solid fa-map-location-dot"></i> ŞEHİR
                            CRM</h3>
                        <span class="text-xs text-green-400 animate-pulse">● CANLI</span>
                    </div>
                    <div class="flex justify-between mt-2 text-sm font-mono">
                        <span class="text-gray-400">İŞARETLİ:</span>
                        <span class="text-white font-bold" id="crm-stats-count">--</span>
                    </div>
                </div>

                <!-- BOX 4: MAP (Placeholder) -->
                <!-- BOX 4: MAP (Restored) -->


                <!-- MAIN CONSOLE (Replaces Traffic Chart) -->
                <div class="cyber-box chart-box-wide flex gap-4 p-4">
                    <!-- Left: Agenda Summary (Full Width Now) -->
                    <div class="w-full">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="box-title mb-0"><i class="fa-regular fa-calendar-check"></i> ANLIK GÜNDEM</h3>
                            <button class="cyber-btn sm" onclick="switchView('agenda')">TÜMÜ</button>
                        </div>
                        <div id="dashboard-agenda-preview" class="text-sm text-gray-400 space-y-2">
                            <!-- JS Puts Items Here -->
                            <div class="text-xs italic text-gray-600">Veri yok...</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <style>
            .city-grid {
                display: grid;
                grid-template-columns: 350px 1fr;
                gap: 20px;
                height: calc(100vh - 180px);
                /* Explicit Height */
            }

            /* OSM Haritasını Karanlık ve Okunabilir Yap */
            .map-tiles-dark {
                filter: invert(90%) hue-rotate(180deg) brightness(0.8) contrast(1.1) grayscale(0.4);
            }
        </style>

        <!-- VIEW: CITY CRM -->
        <section id="view-city_crm" class="view-panel" style="display:none;">
            <div class="city-grid">
                <!-- Sol Panel: Araçlar & Akış -->
                <div class="flex flex-col gap-4">
                    <!-- Azi Analizi -->
                    <div class="cyber-box">
                        <h3 class="box-title text-neon-blue"><i class="fa-solid fa-brain"></i> AZI ANALİZİ</h3>
                        <div id="azi-city-analysis" class="text-sm text-gray-400 p-2 italic leading-relaxed">
                            "Veriler toplanıyor... Henüz yeterli hareket tespit edilmedi."
                        </div>
                    </div>

                    <!-- Takvim / Ajanda -->
                    <div class="cyber-box flex-1">
                        <h3 class="box-title"><i class="fa-regular fa-calendar-check"></i> AJANDA</h3>
                        <div id="mini-calendar" class="grid grid-cols-7 gap-1 mb-4 text-xs">
                            <!-- JS ile doldurulacak -->
                        </div>
                        <h3 class="box-title mt-4"><i class="fa-solid fa-clock-rotate-left"></i> SON AKTİVİTELER</h3>
                        <div id="activity-feed" class="activity-feed custom-scrollbar">
                            <!-- JS ile doldurulacak -->
                        </div>
                    </div>
                </div>

                <!-- Sağ Panel: Harita -->
                <div class="cyber-box relative p-0 overflow-hidden border-neon-blue h-full" style="min-height: 500px;">
                    <div id="city-map" style="width: 100%; height: 100%;"></div>

                    <!-- Harita Kontrolleri (Overlay) -->
                    <div class="absolute top-4 right-4 flex flex-col gap-2 z-[999]">
                        <button class="cyber-btn sm" onclick="CityCRM.setMode('mark')" title="İşaretle">
                            <i class="fa-solid fa-location-dot"></i>
                        </button>
                        <button class="cyber-btn sm" onclick="CityCRM.setMode('ping')" title="Ping At">
                            <i class="fa-solid fa-signal"></i>
                        </button>
                        <button class="cyber-btn sm" onclick="CityCRM.locateMe()" title="Konumum">
                            <i class="fa-solid fa-crosshairs"></i>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- VIEW: VISION (KAMERA) -->
        <section id="view-vision" class="view-panel" style="display:none;">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 h-[calc(100vh-140px)]">
                <!-- Camera Feed -->
                <div class="md:col-span-2 relative cyber-box p-0 overflow-hidden border-neon-blue h-full flex flex-col">
                    <div class="relative flex-1 bg-black overflow-hidden relative group">
                        <!-- ADDED MUTED ATTRIBUTE FOR AUTOPLAY -->
                        <video id="camera-feed" autoplay playsinline muted class="w-full h-full object-cover"
                            style="transform: scaleX(-1);"></video>
                        <canvas id="camera-canvas" class="hidden"></canvas>

                        <!-- HUD Overlay -->
                        <div class="absolute inset-0 pointer-events-none">
                            <div
                                class="absolute top-4 left-4 text-xs text-neon-blue animate-pulse font-mono tracking-widest">
                                REC ● <span id="vision-status">STANDBY</span>
                            </div>
                            <!-- Center Crosshair -->
                            <div
                                class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-16 h-16 border-2 border-neon-blue/30 rounded-full flex items-center justify-center opacity-50 group-hover:opacity-100 transition-opacity">
                                <div class="w-1 h-1 bg-neon-blue rounded-full"></div>
                                <div class="absolute w-full h-[1px] bg-neon-blue/30"></div>
                                <div class="absolute h-full w-[1px] bg-neon-blue/30"></div>
                            </div>

                            <!-- Face Detection Box (Fake Effect) -->
                            <div class="absolute inset-8 border border-neon-blue/10 rounded-lg"></div>
                            <div
                                class="absolute bottom-16 right-8 text-right font-mono text-[10px] text-neon-blue/60 leading-tight">
                                TGT: ALPAY_BEY<br>
                                ID: USER_ADMIN<br>
                                SYS: ONLINE
                            </div>
                        </div>
                    </div>

                    <!-- Controls Toolbar -->
                    <div
                        class="h-16 border-t border-neon-blue/30 bg-slate-900/50 flex items-center justify-between px-4">
                        <div class="text-xs text-gray-400 font-mono">
                            CAM: <span class="text-white">ACTIVE</span> | MODE: <span class="text-yellow-400"
                                id="cam-mode-disp">MANUAL</span>
                        </div>
                        <div class="flex gap-3">
                            <button onclick="VisionAI.toggleAuto()" class="cyber-btn sm" id="btn-cam-auto">
                                <i class="fa-solid fa-robot"></i> OTO İZLE
                            </button>
                            <button onclick="VisionAI.analyzeNow()" class="cyber-btn warning">
                                <i class="fa-regular fa-eye"></i> ANALİZ ET
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Analysis Log & Assistant -->
                <div class="cyber-box flex flex-col h-full bg-slate-900/80">
                    <h3 class="box-title flex justify-between items-center text-neon-blue">
                        <span><i class="fa-solid fa-brain"></i> GÖRSEL ZEKA</span>
                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse" title="Connected"></div>
                    </h3>

                    <div id="vision-log"
                        class="flex-1 overflow-y-auto font-mono text-sm space-y-4 p-2 custom-scrollbar">
                        <div class="text-gray-500 italic text-xs">> Kamera başlatılıyor...</div>
                        <div class="text-gray-500 italic text-xs">> Görüntü işleme ünitesi hazır.</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- VIEW: PRODUCTS (Mevcut) -->

        <section id="view-products" class="view-panel" style="display:none;">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

                <!-- PRODUCT CARD 1: Alpha Staff (HR) - RED THEME -->
                <div class="modern-card"
                    style="border-top: 2px solid #ef4444; background: linear-gradient(135deg, rgba(239, 68, 68, 0.05) 0%, rgba(15, 23, 42, 0.6) 100%);">
                    <div class="mc-header">
                        <span class="mc-subtitle text-red-400">PERSONEL YÖNETİM SİSTEMİ</span>
                        <div class="mc-title text-red-500">Alpha Staff v2</div>
                    </div>
                    <div class="mc-body">
                        <div class="mc-row">
                            <div class="mc-label"><i class="fa-solid fa-code-branch mc-icon text-red-400"></i>
                                Durum
                            </div>
                            <div class="mc-badge bg-red-900/50 text-red-400 font-bold border border-red-500/20">
                                STABLE</div>
                        </div>
                        <div class="mc-row">
                            <div class="mc-label"><i class="fa-solid fa-layer-group mc-icon text-red-400"></i>
                                Modüller</div>
                            <div class="mc-value text-xs">İK, Bordro, Vardiya</div>
                        </div>

                        <div class="p-3 bg-slate-900/50 rounded-lg border border-red-900/30 mt-2">
                            <p class="text-[10px] text-red-400/70 font-bold uppercase mb-2">ÖZELLİKLER</p>
                            <ul class="text-xs text-slate-400 space-y-1">
                                <li><i class="fa-solid fa-check text-red-500 mr-1"></i> QR Personel Giriş Kartı
                                </li>
                                <li><i class="fa-solid fa-check text-red-500 mr-1"></i> Otomatik Bordro
                                    Hesaplama</li>
                                <li><i class="fa-solid fa-check text-red-500 mr-1"></i> Vardiya Planlama Robotu
                                </li>
                            </ul>
                        </div>

                        <p class="text-xs text-gray-500 mt-2 italic">
                            "İşletmeler için personel takibi, maaş yönetimi ve performans analizini
                            kolaylaştırır."
                        </p>
                    </div>
                </div>

                <!-- PRODUCT CARD 2: AlphaStock (Stock Tracking) - BLUE THEME -->
                <div class="modern-card"
                    style="border-top: 2px solid #3b82f6; background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(15, 23, 42, 0.6) 100%);">
                    <div class="mc-header">
                        <span class="mc-subtitle text-blue-400">STOK YÖNETİM SİSTEMİ</span>
                        <div class="mc-title text-blue-500">AlphaStock v1</div>
                    </div>
                    <div class="mc-body">
                        <div class="mc-row">
                            <div class="mc-label"><i class="fa-solid fa-code-branch mc-icon text-blue-400"></i>
                                Durum
                            </div>
                            <div class="mc-badge bg-blue-900/50 text-blue-400 font-bold border border-blue-500/20">
                                BETA</div>
                        </div>
                        <div class="mc-row">
                            <div class="mc-label"><i class="fa-solid fa-layer-group mc-icon text-blue-400"></i>
                                Modüller</div>
                            <div class="mc-value text-xs">Stok, Depo, Sipariş</div>
                        </div>

                        <div class="p-3 bg-slate-900/50 rounded-lg border border-blue-900/30 mt-2">
                            <p class="text-[10px] text-blue-400/70 font-bold uppercase mb-2">ÖZELLİKLER</p>
                            <ul class="text-xs text-slate-400 space-y-1">
                                <li><i class="fa-solid fa-check text-blue-500 mr-1"></i> QR Kod ile Stok
                                    Girişi/Çıkışı
                                </li>
                                <li><i class="fa-solid fa-check text-blue-500 mr-1"></i> Kritik Stok Uyarıları
                                </li>
                                <li><i class="fa-solid fa-check text-blue-500 mr-1"></i> Tedarikçi Entegrasyonu
                                    (Beta)
                                </li>
                            </ul>
                        </div>

                        <p class="text-xs text-gray-500 mt-2 italic">
                            "Depo ve envanter süreçlerini dijitalleştiren, kayıpları önleyen akıllı stok takip
                            sistemi."
                        </p>
                    </div>
                </div>

                <!-- PRODUCT CARD 3: Alpha Emlak (Real Estate) - GREEN THEME -->
                <div class="modern-card"
                    style="border-top: 2px solid #10b981; background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(15, 23, 42, 0.6) 100%);">
                    <div class="mc-header">
                        <span class="mc-subtitle text-emerald-400">PORTFÖY YÖNETİM SİSTEMİ</span>
                        <div class="mc-title text-emerald-500">Alpha Emlak v1</div>
                    </div>
                    <div class="mc-body">
                        <div class="mc-row">
                            <div class="mc-label"><i class="fa-solid fa-code-branch mc-icon text-emerald-400"></i> Durum
                            </div>
                            <div
                                class="mc-badge bg-emerald-900/50 text-emerald-400 font-bold border border-emerald-500/20">
                                YENİ</div>
                        </div>
                        <div class="mc-row">
                            <div class="mc-label"><i class="fa-solid fa-layer-group mc-icon text-emerald-400"></i>
                                Modüller</div>
                            <div class="mc-value text-xs">Portföy, CRM, Bot</div>
                        </div>

                        <div class="p-3 bg-slate-900/50 rounded-lg border border-emerald-900/30 mt-2">
                            <p class="text-[10px] text-emerald-400/70 font-bold uppercase mb-2">ÖZELLİKLER</p>
                            <ul class="text-xs text-slate-400 space-y-1">
                                <li><i class="fa-solid fa-check text-emerald-500 mr-1"></i> Sahibinden Veri Botu
                                </li>
                                <li><i class="fa-solid fa-check text-emerald-500 mr-1"></i> Müşteri Takip (CRM)
                                </li>
                                <li><i class="fa-solid fa-check text-emerald-500 mr-1"></i> AI Değerleme Analizi
                                </li>
                            </ul>
                        </div>

                        <p class="text-xs text-gray-500 mt-2 italic">
                            "Emlak ofisleri için ilan takibi, veri toplama ve müşteri ilişkilerini tek ekranda
                            birleştirir."
                        </p>
                    </div>
                </div>
                <!-- PRODUCT CARD 4: Alpha Class (Education) - YELLOW THEME -->
                <div class="modern-card"
                    style="border-top: 2px solid #f59e0b; background: linear-gradient(135deg, rgba(245, 158, 11, 0.05) 0%, rgba(15, 23, 42, 0.6) 100%);">
                    <div class="mc-header">
                        <span class="mc-subtitle text-amber-400">EĞİTİM YÖNETİM SİSTEMİ</span>
                        <div class="mc-title text-amber-500">Alpha Class v1</div>
                    </div>
                    <div class="mc-body">
                        <div class="mc-row">
                            <div class="mc-label"><i class="fa-solid fa-code-branch mc-icon text-amber-400"></i> Durum
                            </div>
                            <div class="mc-badge bg-amber-900/50 text-amber-400 font-bold border border-amber-500/20">
                                YENİ</div>
                        </div>
                        <div class="mc-row">
                            <div class="mc-label"><i class="fa-solid fa-layer-group mc-icon text-amber-400"></i>
                                Modüller</div>
                            <div class="mc-value text-xs">Sınıf, Yoklama, AI</div>
                        </div>

                        <div class="p-3 bg-slate-900/50 rounded-lg border border-amber-900/30 mt-2">
                            <p class="text-[10px] text-amber-400/70 font-bold uppercase mb-2">ÖZELLİKLER</p>
                            <ul class="text-xs text-slate-400 space-y-1">
                                <li><i class="fa-solid fa-check text-amber-500 mr-1"></i> Akıllı Sınıf Planlama
                                </li>
                                <li><i class="fa-solid fa-check text-amber-500 mr-1"></i> AI Yoklama Analizi
                                </li>
                                <li><i class="fa-solid fa-check text-amber-500 mr-1"></i> Mekan ve Doluluk Haritası
                                </li>
                            </ul>
                        </div>

                        <p class="text-xs text-gray-500 mt-2 italic">
                            "Eğitim kurumları için sınıf yönetimi, devamsızlık takibi ve akıllı öneriler sunar."
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <!-- VIEW: FACTORY (WIZARD) -->
        <section id="view-factory" class="view-panel" style="display:none;">
            <div class="wizard-container">
                <div class="wizard-steps">
                    <div class="step active" id="step1-marker">1. KİMLİK</div>
                    <div class="step" id="step2-marker">2. KAPASİTE</div>
                    <div class="step" id="step3-marker">3. İNŞA (BUILD)</div>
                </div>

                <div class="wizard-content">

                    <!-- STEP 1: IDENTITY -->
                    <div id="step-1" class="step-panel active">
                        <h2 class="section-title">İŞLETME KİMLİK TANIMLAMASI</h2>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-accent-secondary text-xs mb-2">SEKTÖR</label>
                                <select id="wiz-sector" class="input-cyber w-full">
                                    <option value="education">Eğitim / Kurs</option>
                                    <option value="market">Market / Büfe</option>
                                    <option value="cafe">Kafe / Restoran</option>
                                    <option value="tech">Teknoloji / Bilişim</option>
                                    <option value="textile">Tekstil / Giyim</option>
                                    <option value="other">Diğer</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-accent-profit text-xs mb-2">LİSANS BEDELİ (₺)</label>
                                <input type="number" id="wiz-price" class="input-cyber w-full" placeholder="0.00"
                                    value="5000">
                            </div>
                        </div>
                        <div class="input-group">
                            <label>İŞLETME ADI / KODU</label>
                            <input type="text" id="wizName" placeholder="Örn: MARS KAFE LEVENT">
                        </div>
                        <div class="input-group">
                            <label>SİSTEM TÜRÜ</label>
                            <select id="wizType" onchange="toggleCustomReq()" style="border: 1px solid #00f2ff;">
                                <option value="class_tracking" style="color:#f59e0b;">ALPHA CLASS (EĞİTİM)</option>
                                <option value="stock">ALPHA STOK OTOMASYONU</option>
                                <option value="personnel">ALPHA PERSONEL TAKİP</option>
                                <option value="emlak_pro">ALPHA EMLAK OTOMASYONU</option>
                                <option value="custom" style="color:#00f2ff; font-weight:bold;">✨ ÖZEL MİMAR (TERZİ İŞİ)
                                </option>
                            </select>
                        </div>
                        <div class="actions">
                            <button class="cyber-btn" onclick="nextStep(2)">İLERİ >></button>
                        </div>
                    </div>

                    <!-- STEP 2: CAPACITY & ANALYSIS -->
                    <div id="step-2" class="step-panel" style="display:none;">
                        <h2 class="section-title">KAYNAK VE İHTİYAÇ ANALİZİ</h2>

                        <div class="slider-group">
                            <label>PERSONEL KAPASİTESİ: <span id="lblPersonnel" class="val">10</span></label>
                            <input type="range" id="wizPersonnel" min="1" max="100" value="10"
                                oninput="updateRangeIds()">
                        </div>

                        <div class="slider-group">
                            <label>ÜRÜN/STOK HACMİ: <span id="lblProducts" class="val">500</span></label>
                            <input type="range" id="wizProducts" min="100" max="10000" step="100" value="500"
                                oninput="updateRangeIds()">
                        </div>

                        <!-- CUSTOM REQ AREA -->
                        <div id="custom-req-area" style="display:none; margin-top:20px;">
                            <label class="block text-accent-secondary text-xs mb-2" style="color:#00f2ff;">SORUN VE
                                İHTİYAÇ TANIMI</label>
                            <textarea id="wizCustomReq" class="input-cyber w-full" rows="4"
                                placeholder="Örn: Kuryelerin siparişleri karışıyor, harita üzerinde anlık konumlarını görmek istiyorum..."></textarea>
                        </div>

                        <div class="actions">
                            <button class="cyber-btn secondary" onclick="prevStep(1)">
                                << GERİ</button>
                                    <button class="cyber-btn" onclick="startPackaging()">PAKETİ HAZIRLA</button>
                        </div>
                    </div>

                    <!-- STEP 3: BUILD PROCESS -->
                    <div id="step-3" class="step-panel" style="display:none; text-align:center;">
                        <h2 class="section-title blink">SİSTEM İNŞA EDİLİYOR...</h2>

                        <div class="terminal-log" id="buildLog">
                            > SYSTEM INIT... OK<br>
                            > MASTER ENGINE LOCATED... OK<br>
                            > INJECTING LICENSE KEY...
                        </div>

                        <div class="progress-bar">
                            <div class="bar-fill" id="buildProgress"></div>
                        </div>

                        <div id="downloadArea" style="display:none; margin-top:30px;">
                            <h3 style="color:#0f0;">KURULUM PAKETİ HAZIR</h3>
                            <a id="downloadLink" href="/app/AlphaCraftPro_Setup.zip" class="cyber-btn download-btn">
                                [ İNDİR ] ALPHACRAFT_PRO_V2.ZIP
                            </a>
                            <br><br>
                            <small style="color:#666;">Paketi müşteriye gönderin. Kurulum gerekmez.</small>
                            <br>
                            <button class="cyber-btn secondary" onclick="resetWizard()">YENİ KURULUM</button>
                        </div>
                    </div>

                </div>
            </div>
        </section>

        <!-- VIEW: REQUESTS (NEW) -->
        <section id="view-requests" class="view-panel" style="display:none;">
            <div class="cyber-box">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="box-title"><i class="fa-solid fa-inbox"></i> GELEN TALEPLER</h3>
                    <button class="cyber-btn sm" onclick="loadSiteRequests()">
                        <i class="fa-solid fa-rotate"></i> YENİLE
                    </button>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm text-gray-400">
                        <thead class="text-xs uppercase bg-gray-900 text-neon-blue">
                            <tr>
                                <th class="p-3">TARİH</th>
                                <th class="p-3">AD SOYAD</th>
                                <th class="p-3">ŞİRKET</th>
                                <th class="p-3">İLETİŞİM</th>
                                <th class="p-3">ÜRÜN</th>
                                <th class="p-3">NOT</th>
                                <th class="p-3">İŞLEM</th>
                            </tr>
                        </thead>
                        <tbody id="request-table-body">
                            <!-- JS Fills Here -->
                            <tr>
                                <td colspan="7" class="text-center p-4">Yükleniyor...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- VIEW: BUSINESS CARDS (TELEMERY) -->
        <section id="view-active_cards" class="view-panel" style="display: none;">
            <div class="monitor-controls mb-4 flex justify-between items-center">
                <div>
                    <h3 class="text-neon-blue font-bold inline-block mr-4">CANLI İŞLETME DURUMLARI</h3>
                    <div class="text-xs text-gray-500 inline-block">OTOMATİK YENİLEME: <span
                            class="text-green-500">AKTİF</span></div>
                </div>
                <button class="cyber-btn sm warning" onclick="deleteAllLicenses()">
                    <i class="fa-solid fa-trash-can mr-1"></i> AĞI TEMİZLE
                </button>
            </div>

            <div id="business-cards-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- Cards will be injected here via JS -->
            </div>
        </section>

        <!-- VIEW: LEAD HUNTER -->
        <section id="view-leads" class="view-panel" style="display:none;">
            <!-- ÜST BİLGİ KARTLARI -->
            <div class="grid grid-cols-4 gap-4 mb-6">
                <div class="cyber-box">
                    <h3 class="box-title text-gray-400">TOPLAM HEDEF</h3>
                    <div class="text-3xl font-bold text-white" id="stat-total-leads">0</div>
                </div>
                <div class="cyber-box" style="border-top: 2px solid #3b82f6;">
                    <h3 class="box-title text-blue-400">YENİ ADAYLAR</h3>
                    <div class="text-3xl font-bold text-blue-400" id="stat-new-leads">0</div>
                    <div class="text-xs text-gray-500">Müdahale Bekleyen</div>
                </div>
                <div class="cyber-box" style="border-top: 2px solid #eab308;">
                    <h3 class="box-title text-yellow-500">TEMAS KURULAN</h3>
                    <div class="text-3xl font-bold text-yellow-500" id="stat-contacted-leads">0</div>
                    <div class="text-xs text-gray-500">Sunum Gönderildi</div>
                </div>
                <div class="cyber-box" style="border-top: 2px solid #10b981;">
                    <h3 class="box-title text-green-500">DÖNÜŞ YAPAN (REPLIED)</h3>
                    <div class="text-3xl font-bold text-green-500" id="stat-replied-leads">0</div>
                    <div class="text-xs text-gray-500">Sıcak Müşteri!</div>
                </div>
            </div>

            <!-- ANA TABLO ALANI -->
            <div class="cyber-box flex-1 h-[calc(100vh-250px)] flex flex-col">
                <div class="flex justify-between items-center mb-4 border-b border-gray-800 pb-2">
                    <div class="flex gap-2">
                        <button class="cyber-btn sm active" onclick="LeadHunter.filter('all')"
                            id="filter-btn-all">TÜMÜ</button>
                        <button class="cyber-btn sm" onclick="LeadHunter.filter('pending')" id="filter-btn-pending"
                            style="color:#fb923c;">ONAY BEKLEYEN</button>
                        <button class="cyber-btn sm" onclick="LeadHunter.filter('new')" id="filter-btn-new">GÖNDERİME
                            HAZIR</button>
                        <button class="cyber-btn sm" onclick="LeadHunter.filter('replied')" id="filter-btn-replied"
                            style="color:#4ade80;">CEVAPLANANLAR</button>
                    </div>
                    <div class="flex gap-2">
                        <button class="cyber-btn sm warning" onclick="LeadHunter.triggerScan()">
                            <i class="fa-solid fa-satellite-dish"></i> DETAYLI TARA
                        </button>
                        <button class="cyber-btn sm" onclick="LeadHunter.refresh()">
                            <i class="fa-solid fa-rotate"></i>
                        </button>
                    </div>
                </div>

                <div class="overflow-auto custom-scrollbar flex-1">
                    <table class="w-full text-left border-collapse">
                        <thead class="sticky top-0 bg-slate-900 z-10">
                            <tr class="text-xs text-gray-500 border-b border-gray-800">
                                <th class="p-3">DURUM</th>
                                <th class="p-3">E-POSTA</th>
                                <th class="p-3">SKOR</th>
                                <th class="p-3">KAYNAK / ZİNCİR</th>
                                <th class="p-3">SON İŞLEM</th>
                                <th class="p-3">AKSİYON</th>
                            </tr>
                        </thead>
                        <tbody id="leads-table-body" class="text-sm font-mono">
                            <!-- JS ile doldurulacak -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- VIEW: LICENSES -->
        <section id="view-licenses" class="view-panel" style="display:none;">
            <div class="table-container">
                <div class="box-header" style="display:flex; justify-content:space-between;">
                    <span>AĞA BAĞLI NODE'LAR</span>
                    <button class="cyber-btn sm warning" onclick="deleteAllLicenses()">TÜM AĞI TEMİZLE</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>NODE ADI</th>
                            <th>ANAHTAR</th>
                            <th>DURUM</th>
                            <th>BEDEL</th>
                            <th>İŞLEM</th>
                        </tr>
                    </thead>
                    <tbody id="licensesTableBody">
                        <!-- JS Populate -->
                    </tbody>
                </table>
            </div>
        </section>

    </main>

    <!-- INFO MODAL -->
    <div id="businessDetailsModal" class="modal-overlay" style="display: none;">
        <div class="modal-box service-mode">
            <div class="modal-header">
                <h3>NODE DETAYLARI</h3>
                <span class="close-btn" onclick="closeModal()">X</span>
            </div>
            <div class="modal-body">
                <div class="detail-row">
                    <span>İŞLETME:</span> <strong id="cardName" class="text-glow">--</strong>
                </div>
                <div class="detail-row">
                    <span>LİSANS:</span> <span id="cardLicense" class="code-font">--</span>
                </div>
                <div class="detail-row">
                    <span>DURUM:</span> <span id="cardStatus">--</span>
                </div>
                <div class="detail-row">
                    <span>SON SİNYAL:</span> <span id="cardLastSeen">--</span>
                </div>
                <hr class="cyber-hr">
                <div class="detail-row column">
                    <span>SİSTEM TELEMETRİSİ:</span>
                    <div id="cardSystemInfo" class="terminal-view">--</div>
                </div>
                <hr class="cyber-hr">
                <div class="detail-row column">
                    <span>KAPASİTE BİLGİLERİ:</span>
                    <div id="cardDetailsInfo" class="terminal-view">--</div>
                </div>
            </div>
        </div>
    </div>

    <!-- COMMAND MODAL -->
    <div id="commandModal" class="modal-overlay" style="display: none;">
        <div class="modal-box danger-mode">
            <div class="modal-header">
                <h3>UZAKTAN YÖNETİM MERKEZİ</h3>
                <span class="close-btn" onclick="closeCommandModal()">X</span>
            </div>
            <div class="modal-body">
                <div class="detail-row">
                    <span>HEDEF NODE:</span> <strong id="cmdTargetName" class="text-glow">--</strong>
                </div>
                <div class="detail-row">
                    <span>LİSANS:</span> <span id="cmdTargetLicense" class="code-font">--</span>
                </div>

                <hr class="cyber-hr">

                <div class="grid grid-cols-1 gap-4 mt-4">
                    <!-- Mesaj Gönderme -->
                    <div class="cyber-box p-3">
                        <h4 class="text-neon-blue mb-2"><i class="fa-regular fa-message"></i> EKRANA MESAJ GÖNDER</h4>
                        <input type="text" id="cmdMessageInput" class="input-cyber w-full mb-2"
                            placeholder="Mesajınızı yazın...">
                        <button class="cyber-btn w-full" onclick="sendCommand('popup')">GÖNDER</button>
                    </div>

                    <!-- Sistem Kontrol -->
                    <div class="cyber-box p-3" style="border-color: #ef4444;">
                        <h4 class="text-red-500 mb-2"><i class="fa-solid fa-power-off"></i> GÜÇ YÖNETİMİ</h4>
                        <div class="grid grid-cols-2 gap-2">
                            <button class="cyber-btn warning w-full" onclick="sendCommand('lock')">
                                <i class="fa-solid fa-lock"></i> KİLİTLE
                            </button>
                            <button class="cyber-btn danger w-full" onclick="sendCommand('shutdown')">
                                <i class="fa-solid fa-skull"></i> KAPAT
                            </button>
                        </div>
                    </div>

                    <!-- URL Açma -->
                    <div class="cyber-box p-3">
                        <h4 class="text-yellow-400 mb-2"><i class="fa-solid fa-link"></i> TARAYICI AÇ</h4>
                        <input type="text" id="cmdUrlInput" class="input-cyber w-full mb-2" placeholder="https://...">
                        <button class="cyber-btn w-full" onclick="sendCommand('open_url')">AÇ</button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- AZI ORB (VOICE AVATAR) -->
    <!-- Kullanıcı İsteği: Sadece sesli komutu dinlesin, pencere açmasın -->
    <div id="azi-orb-container" onclick="toggleVoice()"
        style="position: fixed; bottom: 30px; right: 30px; cursor: pointer; z-index: 9999;">
        <div class="orb">
            <div class="orb-ring"></div>
            <div class="orb-core"></div>
        </div>
    </div>

    <!-- CHAT MODAL (AI INTERFACE) -->
    <div id="chatModal" class="modal-overlay" style="display: none; align-items: flex-end; justify-content: flex-end;">
        <div class="modal-box"
            style="width: 500px; height: 750px; margin-right: 20px; margin-bottom: 110px; border: 1px solid #00f2ff; box-shadow: 0 0 20px rgba(0, 242, 255, 0.2);">
            <div class="modal-header" style="background: rgba(0, 242, 255, 0.1);">
                <h3 class="text-neon-blue"><i class="fa-solid fa-robot"></i> AZI CHAT</h3>
                <span class="close-btn" onclick="toggleChat()">_</span>
            </div>
            <div class="modal-body"
                style="padding: 0; display: flex; flex-direction: column; height: calc(100% - 40px);">

                <!-- Chat History -->
                <div id="chatHistory"
                    style="flex: 1; overflow-y: auto; padding: 15px; font-family: 'Share Tech Mono', monospace; font-size: 14px;">
                    <div class="chat-msg ai">AZI: Merhaba Alpay Bey. Sistemler aktif. Size nasıl yardımcı olabilirim?
                    </div>
                </div>

                <!-- Input Area -->
                <div class="flex flex-col gap-3">
                    <textarea id="chatInput"
                        class="input-cyber w-full p-3 rounded bg-black/50 border border-cyan-900 focus:border-cyan-400 text-cyan-100"
                        rows="3" placeholder="Komut ver veya soru sor... (Shift+Enter: Alt Satır)"
                        style="resize: none; font-size: 14px; line-height: 1.5;"
                        onkeypress="if(event.key==='Enter' && !event.shiftKey) { event.preventDefault(); sendChat(); }"></textarea>

                    <div class="flex justify-between items-center">
                        <!-- Sol: Ses Kontrolleri -->
                        <div class="flex gap-2">
                            <button id="recordButton" class="cyber-btn sm" onclick="toggleRecording()"
                                title="Sesli Komut">
                                <i class="fa-solid fa-microphone"></i>
                            </button>
                            <button id="speakToggle" class="cyber-btn sm" onclick="toggleSpeech()" title="Sesli Cevap">
                                <i class="fa-solid fa-volume-high"></i>
                            </button>
                            <button id="stopButton" class="cyber-btn sm warning" onclick="stopSpeaking()" title="Durdur"
                                style="border-color:#ef4444; color:#ef4444;">
                                <i class="fa-solid fa-stop"></i>
                            </button>
                        </div>

                        <!-- Sağ: Gönder -->
                        <button class="cyber-btn" onclick="sendChat()"
                            style="width: 140px; height: 40px; background: rgba(0, 242, 255, 0.1); border-color: #00f2ff; color: #00f2ff; font-weight: bold;">
                            GÖNDER <i class="fa-solid fa-paper-plane ml-2"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="config.js"></script>
    <script src="blackbox.js?v=3"></script>
    <script src="city_crm.js?v=2"></script>
    <script src="lead_hunter.js"></script>
    <script src="licenses.js?v=2"></script>
    <script src="vision.js?v=2"></script>
    <script>
        // Init Leads when view is switched
        const originalSwitchView = window.switchView;
        window.switchView = function (viewName) {
            originalSwitchView(viewName);
            if (viewName === 'leads') {
                LeadHunter.init(); // Auto refresh when tab is opened
            }
        };
    </script>
    </script>

    <!-- Website Status Checker Script -->
    <script>
        // --- WEBSITE MONITOR LOGIC ---
        async function checkWebsiteStatus() {
            const elText = document.getElementById('web-status-text');
            const elDot = document.getElementById('web-status-dot');
            const elPing = document.getElementById('web-ping-time');
            const elIcon = document.getElementById('web-status-icon');

            if (!elText) return;

            try {
                // Use relative path to work in both dev and prod
                const res = await fetch('/api/monitor/website');
                const data = await res.json();

                if (data.status === 'ONLINE') {
                    elText.innerText = 'ONLINE';
                    elText.style.color = '#4ade80'; // Green-400
                    elDot.style.backgroundColor = '#22c55e'; // Green-500
                    elDot.style.boxShadow = '0 0 10px #22c55e';
                    elPing.innerText = `PING: ${data.ping}ms`;
                    elIcon.style.color = '#22c55e';
                } else {
                    throw new Error("Status not online");
                }
            } catch (e) {
                elText.innerText = 'OFFLINE';
                elText.style.color = '#ef4444'; // Red-500
                elDot.style.backgroundColor = '#ef4444';
                elDot.style.boxShadow = '0 0 10px #ef4444';
                elPing.innerText = `PING: TIMEOUT`;
                elIcon.style.color = '#ef4444';
            }
        }

        // Start Monitor
        setInterval(checkWebsiteStatus, 30000); // Check every 30s
        checkWebsiteStatus(); // Check immediately on load

        // --- SITE REQUEST LOGIC ---
        async function loadSiteRequests() {
            const tbody = document.getElementById('request-table-body');
            if (!tbody) return;

            tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4 text-neon-blue animate-pulse">Veri alınıyor...</td></tr>';

            try {
                const res = await fetch('/api/requests/active');
                const data = await res.json();

                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center p-4 text-gray-500">Yeni talep yok.</td></tr>';
                    return;
                }

                tbody.innerHTML = data.map(r => `
                    <tr class="border-b border-gray-800 hover:bg-gray-900/50">
                        <td class="p-3 font-mono text-xs">${new Date(r.created_at).toLocaleString('tr-TR')}</td>
                        <td class="p-3 font-bold text-white">${r.name}</td>
                        <td class="p-3">${r.company || '-'}</td>
                        <td class="p-3 text-cyan-400">${r.contact_info}</td>
                        <td class="p-3 text-yellow-500">${r.product_interest}</td>
                        <td class="p-3 text-xs italic max-w-xs truncate" title="${r.note}">${r.note}</td>
                        <td class="p-3">
                            <div class="flex gap-2">
                                <button class="cyber-btn sm success" onclick="archiveRequest(${r.id})" title="Onayla / Arşivle">
                                    <i class="fa-solid fa-check"></i>
                                </button>
                                <button class="cyber-btn sm warning" onclick="deleteRequest(${r.id})" title="Sil" style="border-color:#ef4444; color:#ef4444;">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');

            } catch (e) {
                console.error(e);
                tbody.innerHTML = `<tr><td colspan="7" class="text-center p-4 text-red-500 font-mono">
                    <i class="fa-solid fa-triangle-exclamation"></i> HATA: Sunucuya Ulaşılamadı (${e.message})<br>
                    <span class="text-xs text-gray-500">Lütfen terminali kapatıp yeniden başlatın.</span>
                </td></tr>`;
            }
        }

        async function archiveRequest(id) {
            if (!confirm("Bu talebi okundu olarak işaretleyip arşivlemek istiyor musunuz?")) return;
            try {
                await fetch(`/api/requests/${id}/archive`, { method: 'POST' });
                loadSiteRequests(); // Refresh
            } catch (e) {
                alert("İşlem hatası: " + e);
            }
        }

        async function deleteRequest(id) {
            if (!confirm("Bu kaydı tamamen silmek istediğinize emin misiniz?")) return;
            try {
                const res = await fetch(`/api/requests/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    loadSiteRequests(); // Refresh
                    checkNewRequests(); // Update counters
                } else {
                    alert("Silinemedi.");
                }
            } catch (e) {
                alert("Hata: " + e);
            }
        }

        // --- NEW: NOTIFICATION SYSTEM ---
        async function checkNewRequests() {
            try {
                const res = await fetch('/api/requests/active');
                if (!res.ok) return;
                const data = await res.json();
                const count = data.length;

                // 1. Sidebar Notification
                const menuLink = document.querySelector('li[onclick="switchView(\'requests\')"]');
                if (count > 0) {
                    menuLink.innerHTML = `<i class="fa-solid fa-inbox"></i> SİTE TALEPLERİ <span class="bg-green-500 text-black text-[10px] px-1 rounded ml-1 font-bold animate-pulse">${count}</span>`;
                    menuLink.style.color = '#4ade80'; // Green
                    menuLink.style.textShadow = '0 0 5px #4ade80';
                } else {
                    menuLink.innerHTML = `<i class="fa-solid fa-inbox"></i> SİTE TALEPLERİ`;
                    menuLink.style.color = '';
                    menuLink.style.textShadow = '';
                }

                // 2. Overview Widget
                const widget = document.getElementById('widget-new-requests');
                if (widget) {
                    if (count > 0) {
                        widget.classList.remove('hidden');
                        document.getElementById('widget-req-count').innerText = count;
                    } else {
                        widget.classList.add('hidden');
                    }
                }

            } catch (e) {
                console.error("Notification check fail:", e);
            }
        }

        // Start Polling
        setInterval(checkNewRequests, 10000); // Check every 10s
        checkNewRequests(); // Checking now


        // Auto load if view is active
        // We hook into switchView in blackbox.js logic or add logic here
        const _oldSwitch = window.switchView;
        window.switchView = function (viewId) {
            _oldSwitch(viewId);
            if (viewId === 'requests') loadSiteRequests();
        };
    </script>
</body>

</html>